<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Practitioner Polarity Diagnostic & Reference System - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .status-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.good {
            background: #2ed573;
        }

        .status-indicator.warning {
            background: #ffa726;
        }

        .status-indicator.error {
            background: #ff4757;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .progress-bar {
            background: rgba(200, 200, 200, 0.3);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573 0%, #17a2b8 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            height: fit-content;
            position: sticky;
            top: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .nav-menu {
            list-style: none;
        }

        .nav-menu li {
            margin-bottom: 8px;
        }

        .nav-menu a {
            display: block;
            padding: 12px 16px;
            color: #555;
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .polarity-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .polarity-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .polarity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }

        .polarity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .polarity-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 4px;
        }

        .interactive-polarity {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .interactive-polarity:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .interactive-polarity.untested {
            background: #6c757d !important;
            color: white !important;
            opacity: 0.7 !important;
            border: 2px solid #6c757d !important;
        }

        .interactive-polarity.untested::after {
            content: '⭕';
            margin-left: 8px;
            font-size: 1.2em;
        }

        .interactive-polarity.correct {
            background: #2ed573 !important;
            color: white !important;
            border: 2px solid #2ed573 !important;
            opacity: 1 !important;
        }

        .interactive-polarity.reversed {
            background: #ff4757 !important;
            color: white !important;
            border: 2px solid #ff4757 !important;
            opacity: 1 !important;
        }

        /* ✅ FORCE all interactive polarity indicators to start GREY */
        .polarity-indicator.interactive-polarity {
            background: #6c757d !important;
            color: white !important;
            border: 2px solid #6c757d !important;
            opacity: 0.7 !important;
        }

        /* Only override when explicitly set to specific states */
        .interactive-polarity.correct {
            background: #2ed573 !important;
            border: 2px solid #2ed573 !important;
            opacity: 1 !important;
        }

        .interactive-polarity.reversed {
            background: #ff4757 !important;
            border: 2px solid #ff4757 !important;
            opacity: 1 !important;
        }

        .positive {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            color: white;
        }

        .negative {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            color: white;
        }

        .rotation-symbol {
            font-size: 1.2rem;
            animation: rotate 3s linear infinite;
        }

        .rotation-symbol.cw {
            animation-direction: normal;
        }

        .rotation-symbol.ccw {
            animation-direction: reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .testing-checklist {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid #e9ecef;
        }

        .checklist-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .checklist-item.completed {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            color: white;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox.checked {
            background: #2ed573;
            border-color: #2ed573;
        }

        .checkbox.checked::after {
            content: '✓';
            color: white;
            font-weight: bold;
        }

        .diagnostic-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .diagnostic-result {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .diagnostic-result.success {
            background: rgba(46, 213, 115, 0.2);
            border: 1px solid #2ed573;
        }

        .diagnostic-result.warning {
            background: rgba(255, 167, 38, 0.2);
            border: 1px solid #ffa726;
        }

        .diagnostic-result.error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn.secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 1px solid #ddd;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .warning-alert {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #fff;
        }

        .info-alert {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border-left: 5px solid #fff;
        }

        .finger-diagram {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .hand {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
        }

        .finger {
            display: inline-block;
            width: 60px;
            height: 120px;
            margin: 0 5px;
            border-radius: 30px 30px 10px 10px;
            position: relative;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 0.8rem;
        }

        .interactive-finger {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .interactive-finger:hover {
            transform: scale(1.05);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .finger-status {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid #fff;
        }

        .finger-status.correct {
            background: #2ed573;
            color: white;
        }

        .finger-status.reversed {
            background: #ff4757;
            color: white;
        }

        .analysis-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
        }

        .analysis-status.ready {
            background: #e3f2fd;
            color: #1976d2;
        }

        .analysis-status.analyzing {
            background: #fff3e0;
            color: #f57c00;
        }

        .analysis-status.complete {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .sub-status {
            margin-top: 8px;
            padding: 6px 12px;
            background: #f5f5f5;
            border-radius: 10px;
            border-left: 3px solid #2196f3;
        }

        .sub-status small {
            color: #666;
            font-style: italic;
        }

        .search-filter {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 15px 50px 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #aaa;
        }

        .export-panel {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            margin-top: 25px;
            border: 1px solid #e9ecef;
        }

        .questionnaire-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .question-group {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .jsj-hold-card {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .recommendation-panel {
            background: linear-gradient(135deg, #ffa726 0%, #ff8f00 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
            }
            
            .polarity-grid {
                grid-template-columns: 1fr;
            }
            
            .finger-diagram {
                grid-template-columns: 1fr;
            }

            .status-dashboard {
                grid-template-columns: 1fr;
            }
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .tooltip:hover::after {
            opacity: 1;
        }

        .system-integration {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .urgency-high {
            border-left: 5px solid #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .urgency-medium {
            border-left: 5px solid #ffa726;
            background: rgba(255, 167, 38, 0.1);
        }

        .urgency-low {
            border-left: 5px solid #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        /* Multi-state button styling */
        .multi-state-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 6px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
        }

        .multi-state-btn.not-tested {
            background: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
        }

        .multi-state-btn.positive {
            background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);
            border-color: #2ed573;
            color: white;
        }

        .multi-state-btn.negative {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            border-color: #ff4757;
            color: white;
        }

        .multi-state-btn.weak {
            background: linear-gradient(135deg, #ffa726 0%, #ff8f00 100%);
            border-color: #ffa726;
            color: white;
        }

        .multi-state-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .multi-state-btn[data-tooltip] {
            position: relative;
        }

        .multi-state-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 1;
            pointer-events: none;
            z-index: 1000;
        }

        /* Pattern alert styling */
        .pattern-alert {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 5px solid white;
        }

        .pattern-alert.warning {
            background: linear-gradient(135deg, #ffa726 0%, #ff8f00 100%);
        }

        .pattern-alert.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔬 Advanced Practitioner Polarity Diagnostic System - Enhanced</h1>
            <p>Comprehensive calibration tool with AI-powered integration of QRA, JSJ, Cell Salts & BioGeometry</p>
        </div>

        <div class="status-dashboard">
            <div class="status-card">
                <div class="status-header">
                    <h4>⚖️ Main Calibration</h4>
                    <span class="status-indicator" id="mainStatusIndicator"></span>
                </div>
                <span id="mainStatusText">Not Started</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="mainProgressFill"></div>
                </div>
                <small id="mainProgressText">Progress: 0/13 Steps</small>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <h4>🌊 Energy Channels</h4>
                    <span class="status-indicator" id="channelStatusIndicator"></span>
                </div>
                <span id="channelStatusText">Not Started</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="channelProgressFill"></div>
                </div>
                <small id="channelProgressText">Progress: 0/3 Steps</small>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <h4>⭕ Toroidal Biofield</h4>
                    <span class="status-indicator" id="biofieldStatusIndicator"></span>
                </div>
                <span id="biofieldStatusText">Not Started</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="biofieldProgressFill"></div>
                </div>
                <small id="biofieldProgressText">Progress: 0/5 Steps</small>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <h4>🧠 Overall System</h4>
                    <span class="status-indicator" id="overallStatusIndicator"></span>
                </div>
                <span id="overallStatusText">Awaiting Assessment</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgressFill"></div>
                </div>
                <small id="overallProgressText">Total: 0/21 Steps</small>
            </div>

            <div class="status-card">
                <div class="status-header">
                    <h4>🔍 Analysis Status</h4>
                    <span class="status-indicator" id="analysisStatusIndicator"></span>
                </div>
                <span id="analysisStatusText">Ready to Analyze</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="analysisProgressFill"></div>
                </div>
                <small id="analysisProgressText">Sections Analyzed: 0/5</small>
            </div>
        </div>

        <div class="main-grid">
            <div class="sidebar">
                <h3 style="margin-bottom: 20px; color: #333;">Navigation</h3>
                <ul class="nav-menu">
                    <li><a href="#overview" class="nav-link active" onclick="showSection('overview')">📋 Quick Overview</a></li>
                    <li><a href="#calibration" class="nav-link" onclick="showSection('calibration')">⚖️ Daily Calibration</a></li>
                    <li><a href="#fingers" class="nav-link" onclick="showSection('fingers')">✋ Finger Polarities</a></li>
                    <li><a href="#body" class="nav-link" onclick="showSection('body')">🧑 Body Reference</a></li>
                    <li><a href="#channels" class="nav-link" onclick="showSection('channels')">🌊 Energy Channels</a></li>
                    <li><a href="#biofield" class="nav-link" onclick="showSection('biofield')">⭕ Toroidal Biofield</a></li>
                    <li><a href="#diagnostic" class="nav-link" onclick="showSection('diagnostic')">🔍 Diagnostic Tool</a></li>
                    <li><a href="#objects" class="nav-link" onclick="showSection('objects')">📦 Object Testing</a></li>
                    <li><a href="#troubleshooting" class="nav-link" onclick="showSection('troubleshooting')">⚠️ Troubleshooting</a></li>
                </ul>

                <div id="dynamicRecommendations" style="margin-top: 30px;"></div>
            </div>

            <div class="content-area">
                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search polarity references..." onkeyup="filterContent()">
                    <span class="search-icon">🔍</span>
                </div>

                <!-- Overview Section -->
                <div id="overview" class="section active">
                    <h2>📋 Practitioner Polarity Overview</h2>
                    
                    <div class="info-alert">
                        <h4>🎯 Critical Success Factors</h4>
                        <p><strong>GV-20 must test positive (CW)</strong> before any other testing. This is your primary calibration checkpoint.</p>
                    </div>

                    <div class="quick-actions">
                        <button class="action-btn primary" onclick="startCalibration()">
                            🚀 Start Full Calibration
                        </button>
                        <button class="action-btn secondary" onclick="showSection('diagnostic')">
                            🔍 Run AI Diagnostic
                        </button>
                        <button class="action-btn secondary" onclick="exportComprehensiveReport()">
                            📊 Export Session
                        </button>
                        <button class="action-btn secondary" onclick="clearAllStates()">
                            🔄 Clear All Tests
                        </button>
                        <button class="action-btn secondary" onclick="loadLastSession()">
                            📂 Load Last Session
                        </button>
                        <button class="action-btn secondary" onclick="saveSessionToFile()">
                            💾 Save Session to File
                        </button>
                        <button class="action-btn secondary" onclick="loadSessionFromFile()">
                            📁 Load Session from File
                        </button>
                        <button class="action-btn secondary" onclick="clearSavedSessions()">
                            🗑️ Clear Saved Sessions
                        </button>
                    </div>

                    <div class="polarity-grid">
                        <div class="polarity-card">
                            <h4>⚡ Battery Reference Standard</h4>
                            <p><span class="polarity-indicator positive">Positive (+) <span class="rotation-symbol cw">↻</span> Clockwise</span></p>
                            <p><span class="polarity-indicator negative">Negative (–) <span class="rotation-symbol ccw">↺</span> Counterclockwise</span></p>
                        </div>

                        <div class="polarity-card">
                            <h4>🧠 Critical Head Points (All Must Test Strong)</h4>
                            <p><strong>GV-20 (Crown/Vertex):</strong> <span class="polarity-indicator positive">Must be (+) CW</span></p>
                            <p><strong>Yintang (Third Eye/Pituitary):</strong> <span class="polarity-indicator positive">Must be (+) CW</span></p>
                            <p><strong>GV-17 (Back of Head):</strong> <span class="polarity-indicator positive">Must be Strong</span></p>
                            <small>🎯 These three points determine practitioner testing accuracy</small>
                        </div>

                        <div class="polarity-card">
                            <h4>👁️ Bilateral Patterns</h4>
                            <p><strong>Left Side:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Right Side:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                        </div>

                        <div class="polarity-card">
                            <h4>🌊 Energy Channels</h4>
                            <p><strong>Ida (Left):</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Pingala (Right):</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                        </div>
                    </div>
                </div>

                <!-- Calibration Section -->
                <div id="calibration" class="section">
                    <h2>⚖️ Daily Calibration Sequence</h2>
                    
                    <div class="warning-alert">
                        <h4>⚠️ Pre-Testing Requirements</h4>
                        <p>Complete all steps in order. Any reversal indicates correction needed before proceeding.</p>
                    </div>

                    <div class="testing-checklist">
                        <h3>Morning Calibration Protocol</h3>
                        <div class="checklist-item" onclick="cycleTestState(this, 1, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested" data-tooltip="Click to cycle: ⭕ Not Tested → ✅ Positive → ❌ Negative → ⚠️ Weak">⭕</div>
                            <div>
                                <strong>1. Hydration Check</strong>
                                <p>Drink pure water, ensure proper hydration</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 2, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>2. Remove Jewelry</strong>
                                <p>Remove all metal jewelry from testing hand/wrist</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 3, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>3. Battery Calibration</strong>
                                <p>Positive pole = CW, Negative pole = CCW</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 4, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>4. Finger Polarity Check</strong>
                                <p>Verify all 10 fingers match expected patterns</p>
                                <button class="action-btn secondary" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px;" onclick="showSection('fingers')">
                                    🖐️ Test Individual Fingers
                                </button>
                                <div class="sub-status">
                                    <small id="fingerSubStatus">Detailed finger testing: Not started</small>
                                </div>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 5, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>5. GV-20 Verification (Crown)</strong>
                                <p>CRITICAL: Must test positive (CW) - Master convergence point</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 6, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>6. Yintang Verification (Third Eye)</strong>
                                <p>CRITICAL: Must test positive (CW) - Pituitary/intuition gateway</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 7, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>7. GV-17 Verification (Back of Head)</strong>
                                <p>CRITICAL: Must test strong - Brain integration point</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 8, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>8. Bilateral Eye Test</strong>
                                <p>Left eye = CCW, Right eye = CW</p>
                                <button class="action-btn secondary" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px;" onclick="showSection('body')">
                                    👁️ Test Eye Polarity
                                </button>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 9, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>9. Hand Polarity Test</strong>
                                <p>Left hand = CCW, Right hand = CW</p>
                                <button class="action-btn secondary" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px;" onclick="showSection('body')">
                                    🤚 Test Hand Polarity
                                </button>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 10, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>10. Ida/Pingala Channels</strong>
                                <p>Left = CCW, Right = CW</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 11, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>11. Object Verification</strong>
                                <p>Test pen tip (+) vs back end (–)</p>
                                <button class="action-btn secondary" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px;" onclick="showSection('objects')">
                                    📦 Test Objects
                                </button>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 12, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>12. Apply Corrections</strong>
                                <p>QCI on GV-20/Yintang if any points test weak</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 13, 'main')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>13. Re-verify All</strong>
                                <p>Confirm all critical points now test correctly</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fingers Section -->
                <div id="fingers" class="section">
                    <h2>✋ Finger Polarity Reference (QRA Standard)</h2>
                    
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="action-btn primary" onclick="analyzeFingerResults()">
                            🔍 Analyze Finger Results
                        </button>
                        <div id="fingerAnalysisStatus" class="analysis-status ready">Ready for analysis</div>
                    </div>
                    
                    <div class="finger-diagram">
                        <div class="hand">
                            <h3>🤚 Left Hand</h3>
                            <div style="display: flex; justify-content: center; margin-top: 20px;">
                                <div class="finger interactive-finger" data-hand="left" data-finger="index" data-expected="negative" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);">
                                    <span>Index</span>
                                    <span>North (–)</span>
                                    <span class="rotation-symbol ccw">↺</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="left" data-finger="middle" data-expected="positive" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);">
                                    <span>Middle</span>
                                    <span>South (+)</span>
                                    <span class="rotation-symbol cw">↻</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="left" data-finger="ring" data-expected="negative" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);">
                                    <span>Ring</span>
                                    <span>North (–)</span>
                                    <span class="rotation-symbol ccw">↺</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="left" data-finger="little" data-expected="positive" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);">
                                    <span>Little</span>
                                    <span>South (+)</span>
                                    <span class="rotation-symbol cw">↻</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                            </div>
                        </div>

                        <div class="hand">
                            <h3>🖖 Right Hand</h3>
                            <div style="display: flex; justify-content: center; margin-top: 20px;">
                                <div class="finger interactive-finger" data-hand="right" data-finger="index" data-expected="positive" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);">
                                    <span>Index</span>
                                    <span>South (+)</span>
                                    <span class="rotation-symbol cw">↻</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="right" data-finger="middle" data-expected="negative" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);">
                                    <span>Middle</span>
                                    <span>North (–)</span>
                                    <span class="rotation-symbol ccw">↺</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="right" data-finger="ring" data-expected="positive" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%);">
                                    <span>Ring</span>
                                    <span>South (+)</span>
                                    <span class="rotation-symbol cw">↻</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                                <div class="finger interactive-finger" data-hand="right" data-finger="little" data-expected="negative" onclick="cycleFingerState(this)" style="background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);">
                                    <span>Little</span>
                                    <span>North (–)</span>
                                    <span class="rotation-symbol ccw">↺</span>
                                    <div class="finger-status">⭕</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="info-alert">
                        <h4>🔍 Testing Notes</h4>
                        <p>Use same string length as battery calibration. Any reversal from these patterns indicates practitioner polarity disruption requiring correction.</p>
                        <button class="action-btn secondary" style="margin-top: 15px;" onclick="updateMainCalibrationFromFingers()">
                            ⚖️ Update Main Calibration Status
                        </button>
                        <button class="action-btn primary" style="margin-top: 15px;" onclick="showSection('calibration')">
                            🔄 Return to Calibration
                        </button>
                    </div>
                </div>

                <!-- Body Reference Section -->
                <div id="body" class="section">
                    <h2>🧑 Complete Body Polarity Reference</h2>
                    
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="action-btn primary" onclick="analyzeBilateralResults()">
                            🔍 Analyze Bilateral Results
                        </button>
                        <div id="bilateralAnalysisStatus" class="analysis-status ready">Ready for analysis</div>
                    </div>
                    
                    <div class="polarity-grid">
                        <div class="polarity-card">
                            <h4>🧠 Head & Face - Reference Only</h4>
                            <p><strong>Left Eye:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Right Eye:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                            <p><strong>Left Ear:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Right Ear:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                            <p><strong>Left Temple:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Right Temple:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                            <small style="color: #666; font-style: italic;">ℹ️ If multiple points reverse, see troubleshooting guide - usually corrected by fixing head points and kidneys</small>
                        </div>

                        <div class="polarity-card">
                            <h4>🫁 Respiratory System - Interactive Testing</h4>
                            <p><strong>Left Lung:</strong> <span class="polarity-indicator interactive-polarity" data-test="left-lung" data-expected="negative" onclick="cyclePolarityState(this)">Test Point</span></p>
                            <p><strong>Right Lung:</strong> <span class="polarity-indicator interactive-polarity" data-test="right-lung" data-expected="positive" onclick="cyclePolarityState(this)">Test Point</span></p>
                            <p><strong>Left Nostril:</strong> <span class="polarity-indicator interactive-polarity" data-test="left-nostril" data-expected="negative" onclick="cyclePolarityState(this)">Test Point</span></p>
                            <p><strong>Right Nostril:</strong> <span class="polarity-indicator interactive-polarity" data-test="right-nostril" data-expected="positive" onclick="cyclePolarityState(this)">Test Point</span></p>
                        </div>

                        <div class="polarity-card">
                            <h4>🫘 Kidneys/Adrenals</h4>
                            <p><strong>Left Kidney:</strong> <span class="polarity-indicator negative interactive-polarity" data-test="left-kidney" data-expected="negative" onclick="cyclePolarityState(this)">Past/Lunar (–) CCW</span></p>
                            <p><strong>Right Kidney:</strong> <span class="polarity-indicator positive interactive-polarity" data-test="right-kidney" data-expected="positive" onclick="cyclePolarityState(this)">Present/Solar (+) CW</span></p>
                            <p class="tooltip" data-tooltip="Left often relates to past trauma/stress">
                                <small>Left kidney often relates to past trauma/stress patterns</small>
                            </p>
                        </div>

                        <div class="polarity-card">
                            <h4>🦵 Extremities - Reference Only</h4>
                            <p><strong>Left Arm/Hand:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <p><strong>Right Arm/Hand:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                            <p><strong>Left Leg/Foot:</strong> <span class="polarity-indicator positive">Solar (+) CW</span></p>
                            <p><strong>Right Leg/Foot:</strong> <span class="polarity-indicator negative">Lunar (–) CCW</span></p>
                            <small style="color: #666; font-style: italic;">ℹ️ If multiple extremities reverse, see troubleshooting guide - usually corrected by fixing head points and kidneys</small>
                        </div>

                        <div class="polarity-card">
                            <h4>⬆️ Critical Head Points - Interactive Testing</h4>
                            <p><strong>Crown (GV-20):</strong> <span class="polarity-indicator interactive-polarity" data-test="crown-gv20" data-expected="positive" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 Vertex (highest point), midpoint between ear apexes</small></p>
                            
                            <p><strong>Yintang (Third Eye):</strong> <span class="polarity-indicator interactive-polarity" data-test="yintang" data-expected="positive" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 Midway between eyebrows on forehead midline</small></p>
                            
                            <p><strong>GV-17 (Occiput):</strong> <span class="polarity-indicator interactive-polarity" data-test="gv17-occiput" data-expected="positive" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 Back of head, center of occipital protuberance</small></p>
                            
                            <p><strong>Throat (CV-22):</strong> <span class="polarity-indicator interactive-polarity" data-test="throat-cv22" data-expected="neutral" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 Center of sternal notch on throat midline</small></p>
                            
                            <p><strong>Heart (CV-14):</strong> <span class="polarity-indicator interactive-polarity" data-test="heart-cv14" data-expected="neutral" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 6 cun above umbilicus on midline</small></p>
                            
                            <p><strong>Sacrum/Root:</strong> <span class="polarity-indicator interactive-polarity" data-test="sacrum-root" data-expected="negative" onclick="cyclePolarityState(this)">Test Point</span><br>
                            <small>📍 Base of spine, coccyx area, earth grounding point</small></p>
                        </div>
                    </div>
                </div>

                <!-- Channels Section -->
                <div id="channels" class="section">
                    <h2>🌊 Energy Channel Reference</h2>
                    
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="action-btn primary" onclick="analyzeChannelResults()">
                            🔍 Analyze Channel Results
                        </button>
                        <div id="channelAnalysisStatus" class="analysis-status ready">Ready for analysis</div>
                    </div>
                    
                    <div class="polarity-grid">
                        <div class="polarity-card" style="background: linear-gradient(135deg, #ff6b7a 0%, #ff8a80 100%); color: white;">
                            <h4>🌙 Ida Channel (Left/Lunar)</h4>
                            <p><strong>Nature:</strong> Cooling, Receptive, Feminine</p>
                            <p><strong>Polarity:</strong> <span class="polarity-indicator negative">Negative (–) CCW</span></p>
                            <p><strong>Nostril:</strong> Left nostril breathing</p>
                            <p><strong>Element:</strong> Water, Moon, Night</p>
                            <p><strong>Function:</strong> Introspection, Calm, Rest</p>
                        </div>

                        <div class="polarity-card" style="background: linear-gradient(135deg, #2ed573 0%, #17a2b8 100%); color: white;">
                            <h4>☀️ Pingala Channel (Right/Solar)</h4>
                            <p><strong>Nature:</strong> Heating, Active, Masculine</p>
                            <p><strong>Polarity:</strong> <span class="polarity-indicator positive">Positive (+) CW</span></p>
                            <p><strong>Nostril:</strong> Right nostril breathing</p>
                            <p><strong>Element:</strong> Fire, Sun, Day</p>
                            <p><strong>Function:</strong> Action, Energy, Activity</p>
                        </div>
                    </div>

                    <div class="info-alert">
                        <h4>🧘 Balancing Technique: Alternate Nostril Breathing</h4>
                        <p>Close left nostril, breathe through right (activates Pingala). Close right nostril, breathe through left (activates Ida). Alternate for 5-10 cycles to balance channels.</p>
                    </div>

                    <div class="testing-checklist">
                        <h3>Channel Testing Protocol</h3>
                        <div class="checklist-item" onclick="cycleTestState(this, 'ch1', 'channel')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Left Ida Channel</strong>
                                <p>Should show CCW (negative) polarity</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'ch2', 'channel')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Right Pingala Channel</strong>
                                <p>Should show CW (positive) polarity</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'ch3', 'channel')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>If Imbalanced: Alternate Nostril Breathing</strong>
                                <p>Perform 10 cycles, then re-test</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Biofield Section -->
                <div id="biofield" class="section">
                    <h2>⭕ Toroidal Biofield & Dynamic Energy Sphere</h2>
                    
                    <div class="info-alert">
                        <h4>🌌 Understanding Your Energy Field</h4>
                        <p>The human biofield forms a **toroidal (donut-shaped) energy circulation** around the body. This dynamic sphere extends from one arm's length above your head to the same distance below your feet.</p>
                    </div>

                    <div class="polarity-grid">
                        <div class="polarity-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h4>🔍 Biofield Dimensions</h4>
                            <p><strong>Upper Boundary:</strong> Full arm extension above head (middle finger tip)</p>
                            <p><strong>Lower Boundary:</strong> Same distance below feet into Earth</p>
                            <p><strong>Side Boundaries:</strong> Full arm extension to all sides</p>
                            <p><strong>Shape:</strong> Toroidal sphere with central column</p>
                        </div>

                        <div class="polarity-card">
                            <h4>🔄 Energy Circulation Pattern</h4>
                            <p><strong>Earthly Flow:</strong> <span class="polarity-indicator negative">Up central column (−)</span></p>
                            <p><strong>Crown Expansion:</strong> <span class="polarity-indicator negative">Out and down sides (–)</span></p>
                            <p><strong>Heavenly Flow:</strong> <span class="polarity-indicator positive">Down central column (+)</span></p>
                            <p><strong>Root Expansion:</strong> <span class="polarity-indicator positive">Up sides to crown (+)</span></p>
                        </div>

                        <div class="polarity-card">
                            <h4>🧬 Natural Occurrence</h4>
                            <p>Torus found at all scales:</p>
                            <ul style="margin-top: 10px;">
                                <li>Molecular level structures</li>
                                <li>Apple core, magnetic fields</li>
                                <li>Human energy circulation</li>
                                <li>Planetary energy fields</li>
                                <li>Galactic structures</li>
                            </ul>
                        </div>
                    </div>

                    <div class="testing-checklist">
                        <h3>🔍 Biofield Testing Protocol</h3>
                        <div class="checklist-item" onclick="cycleTestState(this, 'bf1', 'biofield')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Central Column Flow</strong>
                                <p>GV-20 to base of spine - should show strong positive flow</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'bf2', 'biofield')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Upper Boundary (Crown Extension)</strong>
                                <p>One arm's length above head - energy should expand outward</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'bf3', 'biofield')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Lower Boundary (Root Extension)</strong>
                                <p>Same distance below feet - energy should expand upward</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'bf4', 'biofield')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Test Side Boundaries</strong>
                                <p>Full arm extension - should feel energy field edge</p>
                            </div>
                        </div>
                        <div class="checklist-item" onclick="cycleTestState(this, 'bf5', 'biofield')">
                            <div class="multi-state-btn not-tested" data-state="not-tested">⭕</div>
                            <div>
                                <strong>Check for Field Distortions</strong>
                                <p>EMF interference, geopathic stress affecting torus shape</p>
                            </div>
                        </div>
                    </div>

                    <div class="warning-alert">
                        <h4>⚡ Biofield Disruption Indicators</h4>
                        <ul>
                            <li>Asymmetrical field boundaries (one side weaker)</li>
                            <li>Collapsed upper or lower boundaries</li>
                            <li>Central column blockages or reversals</li>
                            <li>EMF distortion patterns in field shape</li>
                            <li>Geopathic stress affecting circulation</li>
                        </ul>
                    </div>

                    <div class="polarity-card">
                        <h4>🔧 Biofield Optimization Methods</h4>
                        <p><strong>BioGeometry Enhancement:</strong> BG3-emitting shapes for field coherence</p>
                        <p><strong>Torus Exercise:</strong> Active circulation of earthly and heavenly flows</p>
                        <p><strong>Environmental Clearing:</strong> EMF protection and geopathic stress neutralization</p>
                        <p><strong>Geometric Amplification:</strong> Sacred geometry for field strengthening</p>
                    </div>
                </div>

                <!-- Diagnostic Section -->
                <div id="diagnostic" class="section">
                    <h2>🔍 Intelligent Multi-System Diagnostic Tool</h2>
                    
                    <div class="diagnostic-panel">
                        <h3>🤖 AI-Powered Pattern Analysis</h3>
                        <p>Answer questions below for comprehensive diagnostic recommendations integrating QRA, JSJ, Cell Salts & BioGeometry.</p>
                    </div>

                    <div class="polarity-card">
                        <h4>🔋 Battery Calibration Results</h4>
                        <label>
                            <input type="radio" name="battery" value="correct" onchange="updateComprehensiveDiagnostic()"> 
                            Positive = CW, Negative = CCW (Correct)
                        </label><br>
                        <label>
                            <input type="radio" name="battery" value="reversed" onchange="updateComprehensiveDiagnostic()"> 
                            Positive = CCW, Negative = CW (Reversed)
                        </label><br>
                        <label>
                            <input type="radio" name="battery" value="weak" onchange="updateComprehensiveDiagnostic()"> 
                            Weak or inconsistent response
                        </label>
                    </div>

                    <div class="polarity-card">
                        <h4>✋ Finger Polarity Results</h4>
                        <label>
                            <input type="radio" name="fingers" value="correct" onchange="updateComprehensiveDiagnostic()"> 
                            All fingers match QRA standard
                        </label><br>
                        <label>
                            <input type="radio" name="fingers" value="partial" onchange="updateComprehensiveDiagnostic()"> 
                            Some fingers reversed
                        </label><br>
                        <label>
                            <input type="radio" name="fingers" value="all_reversed" onchange="updateComprehensiveDiagnostic()"> 
                            All fingers reversed
                        </label>
                    </div>

                    <div class="polarity-card">
                        <h4>🧠 GV-20 Status (Crown Point)</h4>
                        <label>
                            <input type="radio" name="gv20" value="positive" onchange="updateComprehensiveDiagnostic()"> 
                            Tests positive (CW) - Good
                        </label><br>
                        <label>
                            <input type="radio" name="gv20" value="negative" onchange="updateComprehensiveDiagnostic()"> 
                            Tests negative (CCW) - Needs correction
                        </label><br>
                        <label>
                            <input type="radio" name="gv20" value="weak" onchange="updateComprehensiveDiagnostic()"> 
                            Weak or no response
                        </label>
                    </div>

                    <div class="polarity-card">
                        <h4>👁️ Yintang Status (Third Eye/Pituitary)</h4>
                        <label>
                            <input type="radio" name="yintang" value="positive" onchange="updateComprehensiveDiagnostic()"> 
                            Tests positive (CW) - Good
                        </label><br>
                        <label>
                            <input type="radio" name="yintang" value="negative" onchange="updateComprehensiveDiagnostic()"> 
                            Tests negative (CCW) - Needs correction
                        </label><br>
                        <label>
                            <input type="radio" name="yintang" value="weak" onchange="updateComprehensiveDiagnostic()"> 
                            Weak or no response
                        </label>
                    </div>

                    <div class="polarity-card">
                        <h4>🌊 Channel Balance Status</h4>
                        <label>
                            <input type="radio" name="channels" value="balanced" onchange="updateComprehensiveDiagnostic()"> 
                            Ida/Pingala both test correctly
                        </label><br>
                        <label>
                            <input type="radio" name="channels" value="ida_weak" onchange="updateComprehensiveDiagnostic()"> 
                            Ida (left) channel weak
                        </label><br>
                        <label>
                            <input type="radio" name="channels" value="pingala_weak" onchange="updateComprehensiveDiagnostic()"> 
                            Pingala (right) channel weak
                        </label><br>
                        <label>
                            <input type="radio" name="channels" value="both_disrupted" onchange="updateComprehensiveDiagnostic()"> 
                            Both channels disrupted
                        </label>
                    </div>

                    <div class="polarity-card">
                        <h4>⭕ Biofield Integrity</h4>
                        <label>
                            <input type="radio" name="biofield" value="strong" onchange="updateComprehensiveDiagnostic()"> 
                            Strong, symmetrical field boundaries
                        </label><br>
                        <label>
                            <input type="radio" name="biofield" value="asymmetrical" onchange="updateComprehensiveDiagnostic()"> 
                            Asymmetrical or uneven field
                        </label><br>
                        <label>
                            <input type="radio" name="biofield" value="collapsed" onchange="updateComprehensiveDiagnostic()"> 
                            Collapsed or very weak field
                        </label><br>
                        <label>
                            <input type="radio" name="biofield" value="distorted" onchange="updateComprehensiveDiagnostic()"> 
                            EMF/geopathic distortion detected
                        </label>
                    </div>

                    <div id="comprehensiveDiagnosticResults" style="margin-top: 30px;"></div>
                </div>

                <!-- Objects Section -->
                <div id="objects" class="section">
                    <h2>📦 Object Testing Reference</h2>
                    
                    <div class="polarity-grid">
                        <div class="polarity-card">
                            <h4>✏️ Pen/Pencil</h4>
                            <p><strong>Writing Tip:</strong> <span class="polarity-indicator positive interactive-polarity" data-test="pen-tip" data-expected="positive" onclick="cyclePolarityState(this)">Usually (+) CW</span></p>
                            <p><strong>Back End:</strong> <span class="polarity-indicator negative interactive-polarity" data-test="pen-back" data-expected="negative" onclick="cyclePolarityState(this)">Usually (–) CCW</span></p>
                            <small>Great for daily verification - consistent and reliable</small>
                        </div>

                        <div class="polarity-card">
                            <h4>💎 Crystals/Stones</h4>
                            <p><strong>Pointed End:</strong> <span class="polarity-indicator positive interactive-polarity" data-test="crystal-point" data-expected="positive" onclick="cyclePolarityState(this)">Usually (+) CW</span></p>
                            <p><strong>Base/Flat End:</strong> <span class="polarity-indicator negative interactive-polarity" data-test="crystal-base" data-expected="negative" onclick="cyclePolarityState(this)">Usually (–) CCW</span></p>
                            <small>Natural points show strong polarity patterns</small>
                        </div>

                        <div class="polarity-card">
                            <h4>🌱 Plants</h4>
                            <p><strong>Roots:</strong> <span class="polarity-indicator negative interactive-polarity" data-test="plant-roots" data-expected="negative" onclick="cyclePolarityState(this)">Earth (–) CCW</span></p>
                            <p><strong>Crown/Top:</strong> <span class="polarity-indicator positive interactive-polarity" data-test="plant-crown" data-expected="positive" onclick="cyclePolarityState(this)">Sky (+) CW</span></p>
                            <p><strong>Individual Leaves:</strong> <span style="background: #ffa726; color: white; padding: 4px 8px; border-radius: 15px; font-size: 0.8rem;">Varies by position</span></p>
                        </div>

                        <div class="polarity-card">
                            <h4>🐱 Animals</h4>
                            <p><strong>Head/Nose:</strong> <span class="polarity-indicator positive interactive-polarity" data-test="animal-head" data-expected="positive" onclick="cyclePolarityState(this)">Typically (+) CW</span></p>
                            <p><strong>Tail:</strong> <span class="polarity-indicator negative interactive-polarity" data-test="animal-tail" data-expected="negative" onclick="cyclePolarityState(this)">Typically (–) CCW</span></p>
                            <small>Test eyes and ears using human bilateral patterns</small>
                        </div>
                    </div>

                    <div class="info-alert">
                        <h4>💡 Practice Recommendation</h4>
                        <p>Test various household objects daily to maintain sensitivity. Everything has polarity - explore and document your findings!</p>
                        <button class="action-btn primary" style="margin-top: 15px;" onclick="showSection('calibration')">
                            🔄 Return to Calibration
                        </button>
                    </div>
                </div>

                <!-- Troubleshooting Section -->
                <div id="troubleshooting" class="section">
                    <h2>⚠️ Comprehensive Troubleshooting & Correction Guide</h2>
                    
                    <div class="quick-actions" style="margin-bottom: 20px;">
                        <button class="action-btn primary" onclick="runCompleteDiagnostic()">
                            🔍 Run Complete System Analysis
                        </button>
                        <button class="action-btn secondary" onclick="generateLiveRecommendations()">
                            🎯 Generate Live Recommendations
                        </button>
                        <div id="troubleshootingAnalysisStatus" class="analysis-status ready">Ready for full analysis</div>
                    </div>
                    
                    <div class="warning-alert">
                        <h4>🚨 Emergency Protocols</h4>
                        <p>If GV-20 tests negative or weak, STOP all other testing and apply corrections immediately.</p>
                    </div>

                    <!-- Failure Pattern Analysis -->
                    <div id="failurePatternAnalysis" style="margin-top: 20px;"></div>

                    <!-- Cell Salt Constitutional Assessment -->
                    <div class="questionnaire-card">
                        <h3>🌿 Cell Salt Constitutional Assessment</h3>
                        <p>Based on Carey-Perry gestation theory and zodiacal timing protocols</p>
                        
                        <div class="question-group">
                            <h4>📅 Constitutional Calculation</h4>
                            <label>Birth Date: <input type="date" id="birthDate" onchange="calculateConstitution()"></label>
                            <div id="constitutionalResults" style="margin-top: 15px;"></div>
                        </div>

                        <div class="question-group">
                            <h4>👤 Facial Diagnosis Indicators</h4>
                            <label><input type="checkbox" id="greyOcular"> Grey areas around eyes (Kali Phos deficiency)</label><br>
                            <label><input type="checkbox" id="yellowComplexion"> Green-yellow complexion (Nat Sulph deficiency)</label><br>
                            <label><input type="checkbox" id="whiteCoating"> White tongue coating (Kali Mur deficiency)</label><br>
                            <label><input type="checkbox" id="brownCoating"> Brown tongue coating (multiple deficiencies)</label><br>
                            <label><input type="checkbox" id="squareEyes"> Square eye folds (Calc Fluor deficiency)</label>
                        </div>

                        <div class="question-group">
                            <h4>⚡ Current Symptoms</h4>
                            <label><input type="checkbox" id="mentalFatigue"> Mental fatigue, brain fog</label><br>
                            <label><input type="checkbox" id="digestiveIssues"> Digestive problems, bloating</label><br>
                            <label><input type="checkbox" id="jointStiffness"> Joint stiffness, poor elasticity</label><br>
                            <label><input type="checkbox" id="poorSleep"> Sleep issues, insomnia</label><br>
                            <label><input type="checkbox" id="skinProblems"> Skin problems, poor healing</label>
                        </div>

                        <button class="action-btn primary" onclick="generateCellSaltRecommendations()">
                            🧬 Generate Constitutional Recommendations
                        </button>
                        <div id="cellSaltRecommendations" style="margin-top: 20px;"></div>
                    </div>

                    <!-- JSJ Finger Holds for Corrections -->
                    <div class="polarity-card">
                        <h3>🧘 Jin Shin Jyutsu Finger Hold Corrections</h3>
                        <p>Based on QRA measurement point correlations and organ flow timing</p>
                    </div>

                    <div class="polarity-grid">
                        <div class="jsj-hold-card">
                            <h4>👍 THUMB Hold - Worry/Digestive</h4>
                            <p><strong>Use for:</strong> Stomach, Spleen, Pancreas weakness</p>
                            <p><strong>Hold Duration:</strong> 20-60 minutes</p>
                            <p><strong>Peak Time:</strong> 8-10 AM (Stomach), 10 AM-12 PM (Spleen)</p>
                            <p><strong>Attitude:</strong> Transforms worry into centered calm</p>
                            <p><strong>Method:</strong> Wrap fingers around thumb, breathe deeply</p>
                        </div>

                        <div class="jsj-hold-card">
                            <h4>👆 INDEX Hold - Fear/Kidney</h4>
                            <p><strong>Use for:</strong> Kidney, Bladder, Adrenal weakness</p>
                            <p><strong>Hold Duration:</strong> 20-60 minutes</p>
                            <p><strong>Peak Time:</strong> 4-6 PM (Bladder), 6-8 PM (Kidney)</p>
                            <p><strong>Attitude:</strong> Transforms fear into confidence</p>
                            <p><strong>Method:</strong> Wrap fingers around index finger</p>
                        </div>

                        <div class="jsj-hold-card">
                            <h4>🖕 MIDDLE Hold - Anger/Liver</h4>
                            <p><strong>Use for:</strong> Liver, Gallbladder, Eye weakness</p>
                            <p><strong>Hold Duration:</strong> 20-60 minutes</p>
                            <p><strong>Peak Time:</strong> 2-4 AM (Liver), 12-2 AM (Gallbladder)</p>
                            <p><strong>Attitude:</strong> Transforms anger into compassion</p>
                            <p><strong>Method:</strong> Wrap fingers around middle finger</p>
                        </div>

                        <div class="jsj-hold-card">
                            <h4>💍 RING Hold - Sadness/Lung</h4>
                            <p><strong>Use for:</strong> Lung, Large Intestine weakness</p>
                            <p><strong>Hold Duration:</strong> 20-60 minutes</p>
                            <p><strong>Peak Time:</strong> 4-6 AM (Lung), 6-8 AM (Large Intestine)</p>
                            <p><strong>Attitude:</strong> Transforms sadness into joy</p>
                            <p><strong>Method:</strong> Wrap fingers around ring finger</p>
                        </div>

                        <div class="jsj-hold-card">
                            <h4>🤙 LITTLE Hold - Joy/Heart</h4>
                            <p><strong>Use for:</strong> Heart, Small Intestine weakness</p>
                            <p><strong>Hold Duration:</strong> 20-60 minutes</p>
                            <p><strong>Peak Time:</strong> 12-2 PM (Heart), 2-4 PM (Small Intestine)</p>
                            <p><strong>Attitude:</strong> Balances overexcitement</p>
                            <p><strong>Method:</strong> Wrap fingers around little finger</p>
                        </div>

                        <div class="jsj-hold-card">
                            <h4>🧠 BRAIN Integration Protocol</h4>
                            <p><strong>Use for:</strong> GV-20, Yintang, or brain point weakness</p>
                            <p><strong>Method:</strong> Hold all fingers sequentially for 10 minutes each</p>
                            <p><strong>Alternative:</strong> Place hands on head while holding specific finger</p>
                            <p><strong>Special:</strong> For GV-20 weakness, hold all fingers while focusing on crown</p>
                        </div>
                    </div>

                    <!-- Standard Troubleshooting -->
                    <div class="polarity-card">
                        <h4>❌ Problem: Battery Polarity Reversed</h4>
                        <div class="diagnostic-result error">
                            <strong>Symptoms:</strong> Positive pole shows CCW, negative pole shows CW
                        </div>
                        <p><strong>Causes:</strong></p>
                        <ul>
                            <li>Wrong string length - continue adjusting until correct</li>
                            <li>Practitioner polarity reversal (Educational Kinesiology issue)</li>
                            <li>Energy field blockages</li>
                        </ul>
                        <p><strong>Solutions:</strong></p>
                        <ul>
                            <li>Find different string length with correct response</li>
                            <li>Cross Crawl exercise (Brain Gym technique)</li>
                            <li>JSJ: Hold INDEX finger for 20+ minutes</li>
                            <li>Hydration and grounding exercises</li>
                        </ul>
                    </div>

                    <div class="polarity-card">
                        <h4>⚡ Problem: Weak or No Pendulum Response</h4>
                        <div class="diagnostic-result warning">
                            <strong>Symptoms:</strong> Little to no pendulum movement over known polarities
                        </div>
                        <p><strong>JSJ Solutions:</strong></p>
                        <ul>
                            <li>Hold THUMB for 20 minutes (foundation support)</li>
                            <li>Hold INDEX finger if kidney/adrenal exhaustion</li>
                            <li>Sequential finger holds for general energy building</li>
                        </ul>
                        <p><strong>Other Solutions:</strong></p>
                        <ul>
                            <li>Drink pure water immediately</li>
                            <li>Remove all jewelry from testing hand/wrist</li>
                            <li>Use fresh battery or stronger energy source</li>
                        </ul>
                    </div>

                    <div class="polarity-card">
                        <h4>🧠 Problem: GV-20 Tests Negative</h4>
                        <div class="diagnostic-result error">
                            <strong>CRITICAL:</strong> Master point showing reversal - immediate correction required
                        </div>
                        <p><strong>Primary Solutions:</strong></p>
                        <ul>
                            <li>Apply QCI (Quantum Coherence Integration) vial directly on GV-20</li>
                            <li>JSJ: Brain Integration Protocol - hold all fingers sequentially</li>
                            <li>JSJ: Place hands on GV-20 while holding MIDDLE finger (brain support)</li>
                            <li>Hold until point tests positive</li>
                        </ul>
                        <p><strong>Constitutional Support:</strong></p>
                        <ul>
                            <li>Kali Phos for nervous system support</li>
                            <li>Calculate birth salt for constitutional weakness</li>
                            <li>BG3-emitting geometric patterns</li>
                        </ul>
                    </div>

                    <div class="polarity-card">
                        <h4>👁️ Problem: Yintang (Third Eye) Weakness</h4>
                        <div class="diagnostic-result error">
                            <strong>CRITICAL:</strong> Pituitary/intuition gateway blocked
                        </div>
                        <p><strong>JSJ Solutions:</strong></p>
                        <ul>
                            <li>Hold INDEX finger for pituitary support (20-60 minutes)</li>
                            <li>Place one hand on Yintang while holding index finger</li>
                            <li>Brain integration protocol for overall head support</li>
                        </ul>
                        <p><strong>Constitutional Support:</strong></p>
                        <ul>
                            <li>Kali Phos for brain chemistry</li>
                            <li>Calc Phos for pituitary function</li>
                            <li>Third eye meditation with geometric patterns</li>
                        </ul>
                    </div>
                </div>

                <div class="export-panel">
                    <h3>📊 Session Documentation & Export</h3>
                    <div class="quick-actions">
                        <button class="action-btn primary" onclick="exportComprehensiveReport()">📄 Export Complete Report</button>
                        <button class="action-btn secondary" onclick="saveEnhancedSession()">💾 Save Session</button>
                        <button class="action-btn secondary" onclick="printChecklist()">🖨️ Print Protocol</button>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                        Documentation includes constitutional recommendations, JSJ protocols, and multi-system integration guidance for professional practice.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Enhanced state management
        let testStates = {
            main: new Map(),
            channel: new Map(), 
            biofield: new Map()
        };

        let failurePatterns = {
            main: new Set(),
            channel: new Set(),
            biofield: new Set()
        };

        // Interactive testing state management
        let interactiveTestStates = {
            fingers: new Map(),
            bodyParts: new Map(),
            objects: new Map()
        };

        // Analysis status tracking
        let analysisStatus = {
            fingers: false,
            bilateral: false,
            channels: false,
            biofield: false,
            diagnostic: false
        };

        // Finger testing states: 'untested', 'correct', 'reversed'
        function cycleFingerState(element) {
            const hand = element.dataset.hand;
            const finger = element.dataset.finger;
            const expected = element.dataset.expected;
            const key = `${hand}-${finger}`;
            
            const currentState = interactiveTestStates.fingers.get(key) || 'untested';
            const states = ['untested', 'correct', 'reversed'];
            const currentIndex = states.indexOf(currentState);
            const nextIndex = (currentIndex + 1) % states.length;
            const nextState = states[nextIndex];
            
            // Update state
            interactiveTestStates.fingers.set(key, nextState);
            
            // Update visual feedback
            const statusDiv = element.querySelector('.finger-status');
            if (statusDiv) {
                statusDiv.textContent = nextState === 'untested' ? '⭕' : 
                                      nextState === 'correct' ? '✅' : '❌';
                statusDiv.className = `finger-status ${nextState}`;
            }
            
            // Update main calibration Step 4
            updateFingerCalibrationStatus();
            
            // Update overall progress
            updateAllProgress();
            
            // Immediate analysis triggers
            analyzeFailurePatterns();
            updateDynamicRecommendations();
            setTimeout(() => analyzeFingerResults(), 100);
        }

        // Polarity testing states: 'untested', 'correct', 'reversed'
        function cyclePolarityState(element) {
            const test = element.dataset.test;
            const expected = element.dataset.expected;
            
            console.log(`🔄 Clicking ${test}`);
            
            // Get current state (default to 'untested')
            const currentState = interactiveTestStates.bodyParts.get(test) || 'untested';
            
            // Cycle through states: untested → correct → reversed → untested
            const states = ['untested', 'correct', 'reversed'];
            const currentIndex = states.indexOf(currentState);
            const nextIndex = (currentIndex + 1) % states.length;
            const nextState = states[nextIndex];
            
            console.log(`${test}: ${currentState} → ${nextState}`);
            
            // Store the new state
            interactiveTestStates.bodyParts.set(test, nextState);
            
            // ✅ FIX: Update visual appearance with CONSISTENT colors regardless of expected polarity
            element.className = `polarity-indicator interactive-polarity ${nextState}`;
            
            if (nextState === 'correct') {
                element.style.backgroundColor = '#2ed573';  // Always GREEN for correct
                element.style.color = 'white';
                element.style.border = '2px solid #2ed573';
            } else if (nextState === 'reversed') {
                element.style.backgroundColor = '#ff4757';  // Always RED for incorrect
                element.style.color = 'white';
                element.style.border = '2px solid #ff4757';
            } else {
                element.style.backgroundColor = '#6c757d';  // Always GRAY for untested
                element.style.color = 'white';
                element.style.border = '2px solid #6c757d';
                element.style.opacity = '0.7';
            }
            
            // ✅ FIXED: Ensure proper execution order to prevent race conditions
            setTimeout(() => {
                // Update bilateral feedback first
                updateBilateralFeedbackImmediate();
                
                // Then trigger comprehensive analysis
                analyzeFailurePatterns();
                updateDynamicRecommendations();
            }, 50); // Small delay ensures state is fully updated
            
            console.log(`✅ State updated. All body parts:`, Object.fromEntries(interactiveTestStates.bodyParts));
        }

        // Update main calibration Step 4 based on finger testing
        function updateFingerCalibrationStatus() {
            let correctCount = 0;
            let reversedCount = 0;
            let totalTested = 0;
            
            interactiveTestStates.fingers.forEach((state, key) => {
                if (state !== 'untested') {
                    totalTested++;
                    if (state === 'correct') correctCount++;
                    else if (state === 'reversed') reversedCount++;
                }
            });
            
            // Find Step 4 element and update its status
            const step4Element = document.querySelector('[onclick*="cycleTestState"][onclick*="4"]');
            if (step4Element) {
                const btn = step4Element.querySelector('.multi-state-btn');
                if (btn) {
                    let newState = 'not-tested';
                    if (totalTested > 0) {
                        if (reversedCount === 0 && correctCount === totalTested) {
                            newState = 'positive';
                        } else if (reversedCount > 0) {
                            newState = 'negative';
                        } else {
                            newState = 'weak';
                        }
                    }
                    
                    // Update button state
                    btn.className = `multi-state-btn ${newState}`;
                    btn.dataset.state = newState;
                    const symbols = ['⭕', '✅', '❌', '⚠️'];
                    const states = ['not-tested', 'positive', 'negative', 'weak'];
                    const index = states.indexOf(newState);
                    btn.textContent = symbols[index] || '⭕';
                    
                    // Update internal state tracking
                    testStates.main.set(4, newState);
                    
                    // Track failures for pattern analysis
                    if (newState === 'negative' || newState === 'weak') {
                        failurePatterns.main.add(4);
                    } else {
                        failurePatterns.main.delete(4);
                    }
                }
            }
        }

        // Update main calibration based on body part testing
        function updateBodyPartCalibrationStatus(test) {
            let stepToUpdate = null;
            let testType = '';
            
            // Map body parts to main calibration steps
            if (test.includes('eye')) {
                stepToUpdate = 8; // Bilateral Eye Test
                testType = 'eye';
            } else if (test.includes('arm') || test.includes('hand')) {
                stepToUpdate = 9; // Hand Polarity Test
                testType = 'hand';
            }
            
            if (stepToUpdate) {
                const stepElement = document.querySelector(`[onclick*="cycleTestState"][onclick*="${stepToUpdate}"]`);
                if (stepElement) {
                    const btn = stepElement.querySelector('.multi-state-btn');
                    if (btn) {
                        // Check if all related tests are correct
                        let allCorrect = true;
                        let anyReversed = false;
                        
                        if (testType === 'eye') {
                            const leftEye = interactiveTestStates.bodyParts.get('left-eye');
                            const rightEye = interactiveTestStates.bodyParts.get('right-eye');
                            if (leftEye && rightEye) {
                                allCorrect = leftEye === 'correct' && rightEye === 'correct';
                                anyReversed = leftEye === 'reversed' || rightEye === 'reversed';
                            }
                        } else if (testType === 'hand') {
                            const leftArm = interactiveTestStates.bodyParts.get('left-arm');
                            const rightArm = interactiveTestStates.bodyParts.get('right-arm');
                            if (leftArm && rightArm) {
                                allCorrect = leftArm === 'correct' && rightArm === 'correct';
                                anyReversed = leftArm === 'reversed' || rightArm === 'reversed';
                            }
                        }
                        
                        let newState = 'not-tested';
                        if (allCorrect) {
                            newState = 'positive';
                        } else if (anyReversed) {
                            newState = 'negative';
                        } else {
                            newState = 'weak';
                        }
                        
                        // Update button state
                        btn.className = `multi-state-btn ${newState}`;
                        btn.dataset.state = newState;
                        const symbols = ['⭕', '✅', '❌', '⚠️'];
                        const states = ['not-tested', 'positive', 'negative', 'weak'];
                        const index = states.indexOf(newState);
                        btn.textContent = symbols[index] || '⭕';
                        
                        // Update internal state tracking
                        testStates.main.set(stepToUpdate, newState);
                        
                        // Track failures for pattern analysis
                        if (newState === 'negative' || newState === 'weak') {
                            failurePatterns.main.add(stepToUpdate);
                        } else {
                            failurePatterns.main.delete(stepToUpdate);
                        }
                    }
                }
            }
        }

        // Enhanced integration logic
        function updateMainCalibrationFromSubSections() {
            // Check finger results and update Step 4
            updateFingerCalibrationStatus();
            
            // Check body part results and update Steps 8-9
            Object.keys(interactiveTestStates.bodyParts).forEach(test => {
                updateBodyPartCalibrationStatus(test);
            });
            
            // Update overall progress
            updateAllProgress();
            updateDynamicRecommendations();
            analyzeFailurePatterns();
        }

        // Instruction popup functions for clickable recommendations
        function showJSJInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>🧘 JSJ Brain Integration Protocol</h3>
                    <h4>Method:</h4>
                    <ol>
                        <li>Hold THUMB finger for 10 minutes (worry/foundation)</li>
                        <li>Hold INDEX finger for 10 minutes (fear/kidney)</li>
                        <li>Hold MIDDLE finger for 10 minutes (anger/liver)</li>
                        <li>Hold RING finger for 10 minutes (sadness/lung)</li>
                        <li>Hold LITTLE finger for 10 minutes (joy/heart)</li>
                    </ol>
                    <h4>For Critical Points:</h4>
                    <p>Place opposite hand on GV-20 or Yintang while holding each finger</p>
                    
                    <h4>Specific Point Correlations:</h4>
                    <ul>
                        <li><strong>RING Finger:</strong> Lungs, breathing, immune system, respiratory support</li>
                        <li><strong>LITTLE Finger:</strong> Heart, throat, communication, cardiovascular + thyroid</li>
                        <li><strong>INDEX Finger:</strong> Kidneys, adrenals, fear transformation, mineral balance</li>
                        <li><strong>MIDDLE Finger:</strong> Liver, anger transformation, detoxification</li>
                        <li><strong>THUMB Finger:</strong> Digestive system, worry transformation, foundation</li>
                    </ul>
                    
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function showCrossCrawlInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>🔄 Cross Crawl Integration</h3>
                    <h4>Method:</h4>
                    <ol>
                        <li>Stand or sit comfortably</li>
                        <li>Touch right elbow to left knee</li>
                        <li>Touch left elbow to right knee</li>
                        <li>Alternate for 10-20 repetitions</li>
                        <li>Breathe naturally throughout</li>
                    </ol>
                    <h4>Benefits:</h4>
                    <p>Integrates left and right brain hemispheres, improves coordination and energy flow</p>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function showQCIInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>🧪 QCI (Quantum Coherence Integration)</h3>
                    <h4>Method:</h4>
                    <ol>
                        <li>Use QCI vial or essence</li>
                        <li>Apply 2-3 drops to GV-20 (crown)</li>
                        <li>Apply 2-3 drops to Yintang (third eye)</li>
                        <li>Hold for 5-10 minutes</li>
                        <li>Follow with JSJ finger sequence</li>
                    </ol>
                    <h4>For Critical Points:</h4>
                    <p>Use in combination with specific JSJ finger holds for maximum effect</p>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function showBreathingInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>🫁 Alternate Nostril Breathing</h3>
                    <h4>Method:</h4>
                    <ol>
                        <li>Close right nostril, breathe through left (Ida activation)</li>
                        <li>Close left nostril, breathe through right (Pingala activation)</li>
                        <li>Alternate for 5-10 cycles</li>
                        <li>Equal inhale/exhale ratio (4:4:4:4)</li>
                    </ol>
                    <h4>Benefits:</h4>
                    <p>Balances energy channels, calms nervous system, improves focus</p>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function showCellSaltInstructions(specificSalt = null, context = null) {
            let saltContent = '';
            
            // ✅ SPECIFIC SALT RECOMMENDATIONS based on context
            if (specificSalt) {
                switch(specificSalt) {
                    case 'kali-phos':
                        saltContent = `
                            <h3>🧂 Kali Phos (Potassium Phosphate)</h3>
                            <h4>Primary Uses:</h4>
                            <ul>
                                <li><strong>Brain & Nervous System:</strong> Mental fatigue, brain fog, memory issues</li>
                                <li><strong>GV-20 Support:</strong> Crown chakra integration, master convergence point</li>
                                <li><strong>Stress Response:</strong> Nervous exhaustion, anxiety, worry</li>
                                <li><strong>Sleep Issues:</strong> Insomnia from mental overactivity</li>
                            </ul>
                            <h4>Dosage for ${context || 'General Support'}:</h4>
                            <p><strong>Acute:</strong> 4 pellets every 2 hours until improvement</p>
                            <p><strong>Maintenance:</strong> 4 pellets 3x daily before meals</p>
                            <p><strong>Brain Support:</strong> 4 pellets before bed for sleep support</p>
                        `;
                        break;
                        
                    case 'magnesium-phos':
                        saltContent = `
                            <h3>🧂 Magnesium Phosphate (Mag Phos)</h3>
                            <h4>Primary Uses:</h4>
                            <ul>
                                <li><strong>Heart & Circulation:</strong> Heart rhythm, cardiovascular support</li>
                                <li><strong>Muscle Function:</strong> Cramps, spasms, tension</li>
                                <li><strong>CV-14 Support:</strong> Heart chakra center, emotional balance</li>
                                <li><strong>Leo Constitution:</strong> July 22 - August 23 birth dates</li>
                            </ul>
                            <h4>Dosage for ${context || 'Heart Support'}:</h4>
                            <p><strong>Heart Issues:</strong> 4 pellets 3x daily, best at 12-2 PM (heart peak time)</p>
                            <p><strong>Acute Cramps:</strong> 4 pellets every 15 minutes in warm water</p>
                            <p><strong>Emotional Support:</strong> 4 pellets when stressed or overwhelmed</p>
                        `;
                        break;
                        
                    case 'thyroid-support':
                        saltContent = `
                            <h3>🧂 Thyroid Support Protocol</h3>
                            <h4>Primary Salts for CV-22 (Throat):</h4>
                            <ul>
                                <li><strong>Nat Sulph:</strong> Metabolic regulation, liver-thyroid connection</li>
                                <li><strong>Kali Mur:</strong> Glandular function, thyroid hormone production</li>
                                <li><strong>Calc Fluor:</strong> Taurus constitution (throat region)</li>
                                <li><strong>Iodine Support:</strong> Kelp or natural iodine sources</li>
                            </ul>
                            <h4>Dosage for ${context || 'Thyroid Support'}:</h4>
                            <p><strong>Morning:</strong> Nat Sulph 4 pellets on empty stomach</p>
                            <p><strong>Midday:</strong> Kali Mur 4 pellets before lunch</p>
                            <p><strong>Evening:</strong> Calc Fluor 4 pellets before dinner</p>
                            <p><strong>Taurus Season:</strong> Extra support April 20 - May 20</p>
                        `;
                        break;
                        
                    case 'kidney-support':
                        saltContent = `
                            <h3>🧂 Kidney-Adrenal Support Protocol</h3>
                            <h4>Primary Salts for Kidney MPs:</h4>
                            <ul>
                                <li><strong>Nat Mur:</strong> Water distribution, fluid balance</li>
                                <li><strong>Kali Phos:</strong> Nervous system, fear/stress response</li>
                                <li><strong>Calc Phos:</strong> Mineral balance, bone-kidney connection</li>
                                <li><strong>Constitutional Salt:</strong> Based on birth date calculation</li>
                            </ul>
                            <h4>Dosage for ${context || 'Kidney Support'}:</h4>
                            <p><strong>Left Kidney (Past Trauma):</strong> Kali Phos 4 pellets 3x daily</p>
                            <p><strong>Right Kidney (Present Stress):</strong> Nat Mur 4 pellets 3x daily</p>
                            <p><strong>Peak Time:</strong> 6-8 PM for kidney meridian support</p>
                            <p><strong>Constitutional:</strong> Calculate birth salt for deeper support</p>
                        `;
                        break;
                        
                    case 'respiratory-support':
                        saltContent = `
                            <h3>🧂 Respiratory & Immune Support</h3>
                            <h4>Primary Salts for Lung MPs:</h4>
                            <ul>
                                <li><strong>Kali Sulph:</strong> Oxygen transport, respiratory function</li>
                                <li><strong>Ferrum Phos:</strong> Oxygen-carrying capacity, immune support</li>
                                <li><strong>Calc Sulph:</strong> Blood purification, infection resistance</li>
                                <li><strong>Silica:</strong> Structural lung support, tissue repair</li>
                            </ul>
                            <h4>Dosage for ${context || 'Respiratory Support'}:</h4>
                            <p><strong>Acute Respiratory:</strong> Ferrum Phos 4 pellets every 2 hours</p>
                            <p><strong>Chronic Support:</strong> Kali Sulph 4 pellets 3x daily</p>
                            <p><strong>Peak Time:</strong> 4-6 AM for lung meridian support</p>
                            <p><strong>Constitutional:</strong> Alternate salts weekly</p>
                        `;
                        break;
                        
                    case 'calc-fluor':
                        saltContent = `
                            <h3>🧂 Calc Fluor (Calcium Fluoride)</h3>
                            <h4>Primary Uses:</h4>
                            <ul>
                                <li><strong>Structural Integrity:</strong> Connective tissue, ligaments, tendons</li>
                                <li><strong>Eye Support:</strong> Visual system, eye polarity correction</li>
                                <li><strong>Dental Health:</strong> Tooth enamel, gum support</li>
                                <li><strong>Skin Elasticity:</strong> Tissue flexibility, wound healing</li>
                            </ul>
                            <h4>Dosage for ${context || 'Structural Support'}:</h4>
                            <p><strong>Eye Issues:</strong> 4 pellets 3x daily, best before meals</p>
                            <p><strong>Structural Support:</strong> 4 pellets 2x daily for maintenance</p>
                            <p><strong>Peak Time:</strong> 6-8 AM for structural system support</p>
                        `;
                        break;
                        
                    case 'calc-phos':
                        saltContent = `
                            <h3>🧂 Calc Phos (Calcium Phosphate)</h3>
                            <h4>Primary Uses:</h4>
                            <ul>
                                <li><strong>Bone & Energy:</strong> Bone formation, energy metabolism</li>
                                <li><strong>Lower Boundary:</strong> Root chakra, grounding support</li>
                                <li><strong>Growth & Development:</strong> Tissue repair, cell regeneration</li>
                                <li><strong>Nervous System:</strong> Nerve conduction, brain function</li>
                            </ul>
                            <h4>Dosage for ${context || 'Bone & Energy Support'}:</h4>
                            <p><strong>Grounding Support:</strong> 4 pellets 3x daily, best in morning</p>
                            <p><strong>Bone Health:</strong> 4 pellets 2x daily with meals</p>
                            <p><strong>Peak Time:</strong> 6-8 AM for bone/energy system support</p>
                        `;
                        break;
                        
                    default:
                        saltContent = getGenericCellSaltContent();
                        break;
                }
            } else {
                saltContent = getGenericCellSaltContent();
            }
            
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                    ${saltContent}
                    <h4>General Usage Guidelines:</h4>
                    <ul>
                        <li>Dissolve under tongue, avoid touching pellets</li>
                        <li>Take 15-30 minutes before meals or 2 hours after</li>
                        <li>Avoid coffee, mint, strong flavors 30 minutes before/after</li>
                        <li>Store in cool, dark place away from electronics</li>
                    </ul>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function getGenericCellSaltContent() {
            return `
                <h3>🧂 Constitutional Cell Salts Overview</h3>
                <h4>Most Common Protocols:</h4>
                <ul>
                    <li><strong>Kali Phos:</strong> Brain/nervous system - 4 pellets 3x daily</li>
                    <li><strong>Mag Phos:</strong> Heart/muscle function - 4 pellets 3x daily</li>
                    <li><strong>Calc Fluor:</strong> Structural integrity - 4 pellets 3x daily</li>
                    <li><strong>Nat Mur:</strong> Fluid balance - 4 pellets 3x daily</li>
                    <li><strong>Calc Phos:</strong> Bone/energy - 4 pellets 3x daily</li>
                </ul>
            `;
        }

        function closeInstructionPopup() {
            document.querySelector('.jsj-instruction-popup')?.remove();
            document.querySelector('.popup-overlay')?.remove();
        }

        function showEducationalKinesiologyInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>🎓 Educational Kinesiology Protocol</h3>
                    <h4>Method:</h4>
                    <ol>
                        <li>Test muscle strength before intervention</li>
                        <li>Apply specific correction technique</li>
                        <li>Re-test muscle strength</li>
                        <li>Verify polarity correction</li>
                    </ol>
                    <h4>Common Techniques:</h4>
                    <ul>
                        <li><strong>Cross Crawl:</strong> Integrate left/right brain hemispheres</li>
                        <li><strong>Hook-ups:</strong> Calm nervous system</li>
                        <li><strong>Brain Buttons:</strong> Activate brain integration</li>
                        <li><strong>Energy Yawn:</strong> Release jaw tension</li>
                    </ul>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        function showHydrationInstructions() {
            const instructions = `
                <div class="jsj-instruction-popup" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 2000; max-width: 600px;">
                    <h3>💧 Hydration Protocol</h3>
                    <h4>Daily Requirements:</h4>
                    <ul>
                        <li><strong>Pure Water:</strong> 8-10 glasses daily (filtered/distilled)</li>
                        <li><strong>Electrolytes:</strong> Add sea salt or electrolyte powder</li>
                        <li><strong>Timing:</strong> Drink 15-30 minutes before meals</li>
                        <li><strong>Quality:</strong> Avoid tap water, use spring or filtered</li>
                    </ul>
                    <h4>For Polarity Correction:</h4>
                    <p>Increase hydration by 25% during correction protocols. Add lemon or lime for enhanced conductivity.</p>
                    <button class="action-btn primary" onclick="closeInstructionPopup()">✅ Got It</button>
                    <button class="action-btn secondary" onclick="showSection('troubleshooting')">📖 Full Troubleshooting Guide</button>
                </div>
                <div class="popup-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1999;" onclick="closeInstructionPopup()"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', instructions);
        }

        // Section-level analysis functions
        function analyzeFingerResults() {
            const statusDiv = document.getElementById('fingerAnalysisStatus');
            statusDiv.textContent = 'Analyzing...';
            statusDiv.className = 'analysis-status analyzing';
            
            setTimeout(() => {
                const fingerProgress = calculateFingerProgress();
                let analysis = '';
                
                if (fingerProgress.total === 0) {
                    analysis = 'No finger testing completed yet';
                } else if (fingerProgress.reversed > 0) {
                    analysis = `⚠️ ${fingerProgress.reversed} finger(s) reversed:\n`;
                    
                    const jsjMapping = {
                        'index': 'INDEX (kidney/fear support)',
                        'middle': 'MIDDLE (liver/anger support)', 
                        'ring': 'RING (lung/sadness support)',
                        'little': 'LITTLE (heart/joy support)'
                    };
                    
                    let specificRecs = [];
                    interactiveTestStates.fingers.forEach((state, key) => {
                        if (state === 'reversed') {
                            const [hand, finger] = key.split('-');
                            if (jsjMapping[finger]) {
                                specificRecs.push(`${hand.toUpperCase()} ${finger}: Hold ${jsjMapping[finger]} 20-60 min`);
                            }
                        }
                    });
                    
                    analysis += specificRecs.join('; ');
                } else if (fingerProgress.correct === fingerProgress.total) {
                    analysis = `✅ All ${fingerProgress.total} fingers testing correctly!`;
                } else {
                    analysis = `🔄 ${fingerProgress.correct}/${fingerProgress.total} fingers correct`;
                }
                
                statusDiv.textContent = analysis;
                statusDiv.className = 'analysis-status complete';
                
                analysisStatus.fingers = true;
                updateAnalysisStatus();
            }, 1000);
        }

        function analyzeBilateralResults() {
            console.log('🔍 Manual bilateral analysis triggered');
            updateBilateralFeedbackImmediate();
            analysisStatus.bilateral = true;
            updateAnalysisStatus();
        }

        function analyzeChannelResults() {
            const statusDiv = document.getElementById('channelAnalysisStatus');
            statusDiv.textContent = 'Analyzing...';
            statusDiv.className = 'analysis-status analyzing';
            
            setTimeout(() => {
                const channelProgress = calculateProgress('channel');
                let analysis = '';
                
                if (channelProgress.tested === 0) {
                    analysis = 'No channel testing completed yet';
                } else if (channelProgress.negative > 0 || channelProgress.weak > 0) {
                    analysis = `⚠️ ${channelProgress.negative + channelProgress.weak} channel(s) imbalanced - Requires breathing correction`;
                } else if (channelProgress.positive === channelProgress.total) {
                    analysis = `✅ All ${channelProgress.total} channels balanced!`;
                } else {
                    analysis = `🔄 ${channelProgress.positive}/${channelProgress.total} channels balanced`;
                }
                
                statusDiv.textContent = analysis;
                statusDiv.className = 'analysis-status complete';
                
                analysisStatus.channels = true;
                updateAnalysisStatus();
            }, 1000);
        }

        // Update analysis status dashboard
        function updateAnalysisStatus() {
            const completed = Object.values(analysisStatus).filter(Boolean).length;
            const total = Object.keys(analysisStatus).length;
            const percentage = (completed / total) * 100;
            
            document.getElementById('analysisProgressFill').style.width = percentage + '%';
            document.getElementById('analysisProgressText').textContent = `Sections Analyzed: ${completed}/${total}`;
            
            const status = completed === total ? 'complete' : completed > 0 ? 'analyzing' : 'ready';
            updateStatusIndicator('analysisStatusIndicator', 'analysisStatusText', {status});
        }

        // Cross-section integration functions
        function updateMainCalibrationFromFingers() {
            updateFingerCalibrationStatus();
            
            // Show completion message
            const fingerProgress = calculateFingerProgress();
            if (fingerProgress.total > 0) {
                document.getElementById('fingerSubStatus').innerHTML = 
                    `✅ Detailed finger testing: ${fingerProgress.correct}/${fingerProgress.total} correct`;
            }
            
            // Auto-navigate back to calibration
            setTimeout(() => {
                if (confirm('Return to main calibration to see updated status?')) {
                    showSection('calibration');
                }
            }, 1000);
        }

        // Complete diagnostic functions
        function runCompleteDiagnostic() {
            const statusDiv = document.getElementById('troubleshootingAnalysisStatus');
            statusDiv.textContent = 'Running complete analysis...';
            statusDiv.className = 'analysis-status analyzing';
            
            // Run all analyses
            analyzeFailurePatterns();
            updateDynamicRecommendations();
            
            // Trigger specific analyses if data exists
            const fingerProgress = calculateFingerProgress();
            if (fingerProgress.total > 0) analyzeFingerResults();
            
            // Check bilateral testing
            const bilateralTested = ['left-eye', 'right-eye', 'left-arm', 'right-arm'].some(test => 
                interactiveTestStates.bodyParts.has(test));
            if (bilateralTested) analyzeBilateralResults();
            
            // Check channel testing
            const channelProgress = calculateProgress('channel');
            if (channelProgress.tested > 0) analyzeChannelResults();
            
            setTimeout(() => {
                statusDiv.textContent = '✅ Complete analysis finished';
                statusDiv.className = 'analysis-status complete';
            }, 2000);
        }

        function generateLiveRecommendations() {
            // Force refresh all recommendations
            updateDynamicRecommendations();
            analyzeFailurePatterns();
            
            // Show completion message
            alert('Live recommendations updated based on current test states!');
        }

        // Real-time bilateral feedback function
        function updateBilateralFeedback() {
            const leftTests = ['left-eye', 'left-ear', 'left-temple', 'left-arm', 'left-leg', 'left-kidney'];
            const rightTests = ['right-eye', 'right-ear', 'right-temple', 'right-arm', 'right-leg', 'right-kidney'];
            const criticalTests = ['crown-gv20', 'yintang', 'gv17-occiput', 'sacrum-root'];
            
            let leftReversed = 0, leftTested = 0;
            let rightReversed = 0, rightTested = 0;
            let criticalReversed = 0, criticalTested = 0;
            
            leftTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    leftTested++;
                    if (state === 'reversed') leftReversed++;
                }
            });
            
            rightTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    rightTested++;
                    if (state === 'reversed') rightReversed++;
                }
            });
            
            criticalTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    criticalTested++;
                    if (state === 'reversed') criticalReversed++;
                }
            });
            
            // Update the bilateral analysis status div immediately
            const statusDiv = document.getElementById('bilateralAnalysisStatus');
            if (statusDiv) {
                let analysis = '';
                if (leftReversed > 0 || rightReversed > 0) {
                    analysis = `⚠️ Left: ${leftReversed}/${leftTested} reversed, Right: ${rightReversed}/${rightTested} reversed`;
                } else if (leftTested > 0 || rightTested > 0) {
                    analysis = `✅ Bilateral testing: ${leftTested + rightTested} points balanced`;
                } else {
                    analysis = 'No bilateral testing completed yet';
                }
                
                // Add critical points status if any tested
                if (criticalTested > 0) {
                    if (criticalReversed > 0) {
                        analysis += ` | 🚨 Critical: ${criticalReversed}/${criticalTested}`;
                    } else {
                        analysis += ` | ✅ Critical: ${criticalTested}/${criticalTested}`;
                    }
                }
                
                statusDiv.textContent = analysis;
                statusDiv.className = leftReversed > 0 || rightReversed > 0 ? 'analysis-status analyzing' : 'analysis-status complete';
            }
        }

        // New immediate bilateral feedback function
        function updateBilateralFeedbackImmediate() {
            const leftTests = ['left-eye', 'left-ear', 'left-temple', 'left-arm', 'left-leg', 'left-kidney'];
            const rightTests = ['right-eye', 'right-ear', 'right-temple', 'right-arm', 'right-leg', 'right-kidney'];
            const headTests = ['crown-gv20', 'yintang', 'gv17-occiput'];
            
            let leftCorrect = 0, leftReversed = 0, leftTotal = 0;
            let rightCorrect = 0, rightReversed = 0, rightTotal = 0;
            let headCorrect = 0, headReversed = 0, headTotal = 0;
            
            // Count left side
            leftTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    leftTotal++;
                    if (state === 'correct') leftCorrect++;
                    if (state === 'reversed') leftReversed++;
                }
            });
            
            // Count right side  
            rightTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    rightTotal++;
                    if (state === 'correct') rightCorrect++;
                    if (state === 'reversed') rightReversed++;
                }
            });
            
            // Count head points
            headTests.forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state && state !== 'untested') {
                    headTotal++;
                    if (state === 'correct') headCorrect++;
                    if (state === 'reversed') headReversed++;
                }
            });
            
            // Create detailed feedback
            let feedback = '';
            if (leftTotal === 0 && rightTotal === 0 && headTotal === 0) {
                feedback = 'No bilateral testing completed yet';
            } else {
                feedback = `LEFT: ${leftCorrect}✅ ${leftReversed}❌ | RIGHT: ${rightCorrect}✅ ${rightReversed}❌ | HEAD: ${headCorrect}✅ ${headReversed}❌`;
                
                if (leftReversed + rightReversed + headReversed > 0) {
                    feedback += ' ⚠️ REVERSALS DETECTED';
                } else {
                    feedback += ' ✅ ALL BALANCED';
                }
            }
            
            // Update the bilateral status immediately
            const statusDiv = document.getElementById('bilateralAnalysisStatus');
            if (statusDiv) {
                statusDiv.textContent = feedback;
                statusDiv.className = (leftReversed + rightReversed + headReversed > 0) ? 'analysis-status analyzing' : 'analysis-status complete';
            }
            
            console.log(`📊 Bilateral Status: ${feedback}`);
        }

        let diagnosticData = {};
        let sessionLog = [];

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');

            updateDynamicRecommendations();
        }

        // Enhanced calibration management
        function startCalibration() {
            showSection('calibration');
            updateAllProgress();
        }

        // Multi-state cycling function
        function cycleTestState(element, checkId, system) {
            const btn = element.querySelector('.multi-state-btn');
            const currentState = btn.dataset.state;
            
            const states = ['not-tested', 'positive', 'negative', 'weak'];
            const symbols = ['⭕', '✅', '❌', '⚠️'];
            const currentIndex = states.indexOf(currentState);
            const nextIndex = (currentIndex + 1) % states.length;
            const nextState = states[nextIndex];
            
            // Update button appearance
            btn.className = `multi-state-btn ${nextState}`;
            btn.dataset.state = nextState;
            btn.textContent = symbols[nextIndex];
            
            // Update internal state tracking
            testStates[system].set(checkId, nextState);
            
            // Track failures for pattern analysis
            if (nextState === 'negative' || nextState === 'weak') {
                failurePatterns[system].add(checkId);
            } else {
                failurePatterns[system].delete(checkId);
            }
            
            // Update all progress and recommendations
            updateAllProgress();
            analyzeFailurePatterns();
            updateDynamicRecommendations();
            
            // Trigger immediate channel analysis for channel system
            if (system === 'channel') {
                setTimeout(() => analyzeChannelResults(), 100);
            }
        }



        // Enhanced progress calculation
        function calculateProgress(system) {
            const states = testStates[system];
            const total = getSystemTotal(system);
            
            let positive = 0;
            let negative = 0;
            let weak = 0;
            let tested = 0;
            
            states.forEach((state, id) => {
                if (state !== 'not-tested') tested++;
                if (state === 'positive') positive++;
                if (state === 'negative') negative++;
                if (state === 'weak') weak++;
            });
            
            return {
                positive,
                negative, 
                weak,
                tested,
                total,
                positivePercentage: (positive / total) * 100,
                testedPercentage: (tested / total) * 100
            };
        }

        // Enhanced progress with sub-component details
        function getDetailedProgress() {
            const mainProgress = calculateProgress('main');
            const channelProgress = calculateProgress('channel');
            const biofieldProgress = calculateProgress('biofield');
            
            // Calculate sub-component progress
            const fingerProgress = calculateFingerProgress();
            const eyeProgress = calculateEyeProgress();
            const handProgress = calculateHandProgress();
            
            return {
                main: mainProgress,
                channel: channelProgress,
                biofield: biofieldProgress,
                subComponents: {
                    fingers: fingerProgress,
                    eyes: eyeProgress,
                    hands: handProgress
                }
            };
        }

        function calculateFingerProgress() {
            let correct = 0;
            let reversed = 0;
            let total = 0;
            
            interactiveTestStates.fingers.forEach((state, key) => {
                total++;
                if (state === 'correct') correct++;
                else if (state === 'reversed') reversed++;
            });
            
            return {
                correct,
                reversed,
                total,
                percentage: total > 0 ? (correct / total) * 100 : 0
            };
        }

        function calculateEyeProgress() {
            const leftEye = interactiveTestStates.bodyParts.get('left-eye');
            const rightEye = interactiveTestStates.bodyParts.get('right-eye');
            
            let correct = 0;
            if (leftEye === 'correct') correct++;
            if (rightEye === 'correct') correct++;
            
            return {
                correct,
                total: 2,
                percentage: (correct / 2) * 100
            };
        }

        function calculateHandProgress() {
            const leftArm = interactiveTestStates.bodyParts.get('left-arm');
            const rightArm = interactiveTestStates.bodyParts.get('right-arm');
            
            let correct = 0;
            if (leftArm === 'correct') correct++;
            if (rightArm === 'correct') correct++;
            
            return {
                correct,
                total: 2,
                percentage: (correct / 2) * 100
            };
        }

        function getSystemTotal(system) {
            switch(system) {
                case 'main': return 13;
                case 'channel': return 3;
                case 'biofield': return 5;
                default: return 0;
            }
        }

        // Update the existing updateAllProgress function
        function updateAllProgress() {
            // Main calibration
            const mainProgress = calculateProgress('main');
            document.getElementById('mainProgressFill').style.width = mainProgress.positivePercentage + '%';
            document.getElementById('mainProgressText').textContent = 
                `Positive: ${mainProgress.positive}/${mainProgress.total} | Failed: ${mainProgress.negative}`;
            updateStatusIndicator('mainStatusIndicator', 'mainStatusText', mainProgress);
            
            // Channel progress  
            const channelProgress = calculateProgress('channel');
            document.getElementById('channelProgressFill').style.width = channelProgress.positivePercentage + '%';
            document.getElementById('channelProgressText').textContent = 
                `Positive: ${channelProgress.positive}/${channelProgress.total} | Failed: ${channelProgress.negative}`;
            updateStatusIndicator('channelStatusIndicator', 'channelStatusText', channelProgress);
            
            // Biofield progress
            const biofieldProgress = calculateProgress('biofield');
            document.getElementById('biofieldProgressFill').style.width = biofieldProgress.positivePercentage + '%';
            document.getElementById('biofieldProgressText').textContent = 
                `Positive: ${biofieldProgress.positive}/${biofieldProgress.total} | Failed: ${biofieldProgress.negative}`;
            updateStatusIndicator('biofieldStatusIndicator', 'biofieldStatusText', biofieldProgress);
            
            // Overall progress
            const totalPositive = mainProgress.positive + channelProgress.positive + biofieldProgress.positive;
            const totalNegative = mainProgress.negative + channelProgress.negative + biofieldProgress.negative;
            const totalSteps = 21;
            const overallPercentage = (totalPositive / totalSteps) * 100;
            
            document.getElementById('overallProgressFill').style.width = overallPercentage + '%';
            document.getElementById('overallProgressText').textContent = 
                `Positive: ${totalPositive}/${totalSteps} | Failed: ${totalNegative}`;
            
            const overallStatus = totalNegative > 0 ? 'error' : (totalPositive < totalSteps ? 'warning' : 'good');
            updateStatusIndicator('overallStatusIndicator', 'overallStatusText', {status: overallStatus});
            
            // Trigger automatic failure pattern analysis
            analyzeFailurePatterns();
        }

        // Enhanced progress status determination
        function getSystemStatus(progress) {
            const { positive, negative, weak, total } = progress;
            
            if (negative > 0 || weak >= total/2) return 'error';
            if (weak > 0 || positive < total) return 'warning'; 
            return 'good';
        }

        function updateStatusIndicator(indicatorId, textId, progress) {
            const indicator = document.getElementById(indicatorId);
            const text = document.getElementById(textId);
            
            const status = progress.status || getSystemStatus(progress);
            
            indicator.className = `status-indicator ${status}`;
            
            if (status === 'error') {
                text.textContent = 'Critical Issues';
            } else if (status === 'warning') {
                text.textContent = 'Needs Attention';
            } else {
                text.textContent = 'Optimal ✓';
            }
        }

        // Enhanced failure pattern analysis with sub-component data
        function analyzeFailurePatterns() {
            const analysisDiv = document.getElementById('failurePatternAnalysis') || createAnalysisDiv();
            let alerts = '';
            
            // ✅ COMPREHENSIVE: Check EVERY individual body reference point failure
            let individualBodyFailures = [];
            Object.entries(interactiveTestStates.bodyParts).forEach(([testName, state]) => {
                if (state === 'reversed') {
                    individualBodyFailures.push(testName);
                }
            });

            // ✅ DEBUGGING: Log what we found (remove this later)
            if (individualBodyFailures.length > 0) {
                console.log(`🔍 DETECTED BODY FAILURES:`, individualBodyFailures);
            }

            // ✅ INDIVIDUAL POINT RECOMMENDATIONS (before pattern analysis)
            individualBodyFailures.forEach(testName => {
                let pointRecommendation = '';
                
                // Critical head points
                if (testName === 'crown-gv20') {
                    pointRecommendation = `
                        <div class="pattern-alert">
                            🧠 <strong>GV-20 (CROWN) REVERSED</strong><br>
                            CRITICAL: Master convergence point failed<br>
                            Protocol: <button class='action-btn secondary' onclick='showQCIInstructions()'>🧪 QCI Application</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Brain Integration</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kali-phos", "GV-20 Crown Support")'>🧂 Kali Phos</button>
                        </div>
                    `;
                } else if (testName === 'yintang') {
                    pointRecommendation = `
                        <div class="pattern-alert">
                            👁️ <strong>YINTANG (THIRD EYE) REVERSED</strong><br>
                            CRITICAL: Pituitary/intuition gateway blocked<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger (pituitary support)</button> + <button class='action-btn secondary' onclick='showQCIInstructions()'>🧪 QCI Application</button>
                        </div>
                    `;
                } else if (testName === 'gv17-occiput') {
                    pointRecommendation = `
                        <div class="pattern-alert">
                            🧠 <strong>GV-17 (OCCIPUT) REVERSED</strong><br>
                            CRITICAL: Brain integration point failed<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Brain Integration</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kali-phos", "GV-17 Occiput Support")'>🧂 Kali Phos</button>
                        </div>
                    `;
                } else if (testName === 'throat-cv22') {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🗣️ <strong>THROAT (CV-22) REVERSED</strong><br>
                            Thyroid/metabolic regulation affected<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger (communication/thyroid)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("thyroid-support", "Throat CV-22 Support")'>🧂 Thyroid Support</button>
                        </div>
                    `;
                } else if (testName === 'heart-cv14') {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            ❤️ <strong>HEART (CV-14) REVERSED</strong><br>
                            Cardiovascular/emotional center affected<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger (heart support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("magnesium-phos", "Heart CV-14 Support")'>🧂 Magnesium Phosphate</button><br>
                            <small>Peak time: 12-2 PM for maximum effectiveness</small>
                        </div>
                    `;
                } else if (testName === 'sacrum-root') {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🌱 <strong>SACRUM/ROOT REVERSED</strong><br>
                            Earth grounding connection disrupted<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ THUMB Finger (foundation)</button> + <button class='action-btn secondary' onclick='showSection("troubleshooting")'>🌍 Grounding Exercises</button>
                        </div>
                    `;
                } else if (testName === 'left-kidney') {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🫘 <strong>LEFT KIDNEY REVERSED</strong><br>
                            Past trauma/lunar energy disrupted<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger (kidney support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kidney-support", "Left Kidney Support")'>🧂 Constitutional Assessment</button>
                        </div>
                    `;
                } else if (testName === 'right-kidney') {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🫘 <strong>RIGHT KIDNEY REVERSED</strong><br>
                            Present stress/solar energy disrupted<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger (kidney support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kidney-support", "Right Kidney Support")'>🧂 Constitutional Assessment</button>
                        </div>
                    `;
                } else if (testName.includes('lung')) {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🫁 <strong>${testName.toUpperCase()} REVERSED</strong><br>
                            Respiratory function affected<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ RING Finger (respiratory support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("respiratory-support", "Lung Support")'>🧂 Respiratory Support</button>
                        </div>
                    `;
                } else if (testName.includes('nostril')) {
                    pointRecommendation = `
                        <div class="pattern-alert warning">
                            🫁 <strong>${testName.toUpperCase()} REVERSED</strong><br>
                            Energy channel breathing affected<br>
                            Protocol: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Alternate Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Channel Balancing</button>
                        </div>
                    `;
                } else {
                    // Generic recommendation for any other points
                    pointRecommendation = `
                        <div class="pattern-alert info">
                            📍 <strong>${testName.toUpperCase()} REVERSED</strong><br>
                            Individual point correction needed<br>
                            Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Appropriate Finger Hold</button> + <button class='action-btn secondary' onclick='showSection("troubleshooting")'>📖 See Full Protocol Guide</button>
                        </div>
                    `;
                }
                
                alerts += pointRecommendation;
            });

            // ✅ ADD: Summary if multiple individual failures
            if (individualBodyFailures.length >= 3) {
                alerts += `
                    <div class="pattern-alert">
                        ⚠️ <strong>MULTIPLE INDIVIDUAL POINT FAILURES</strong><br>
                        ${individualBodyFailures.length} body reference points reversed<br>
                        Consider: <button class='action-btn secondary' onclick='showEducationalKinesiologyInstructions()'>🎓 Educational Kinesiology</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 Comprehensive JSJ Protocol</button>
                    </div>
                `;
            }
            
            // Critical head point pattern
            const headFailures = [];
            if (failurePatterns.main.has(5)) headFailures.push('GV-20');
            if (failurePatterns.main.has(6)) headFailures.push('Yintang');
            if (failurePatterns.main.has(7)) headFailures.push('GV-17');
            
            if (headFailures.length >= 2) {
                alerts += `
                    <div class="pattern-alert">
                        🚨 <strong>CRITICAL HEAD POINT FAILURE</strong><br>
                        Failed: ${headFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showQCIInstructions()'>🧪 QCI</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Brain Integration</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kali-phos", "Critical Head Point Support")'>🧂 Kali Phos</button>
                    </div>
                `;
            }
            
            // ✅ ADD: Enhanced bilateral pattern analysis for troubleshooting
            const leftSideFailures = [];
            const rightSideFailures = [];
            const headPointFailures = [];

            // Check bilateral body part failures
            ['left-eye', 'left-ear', 'left-temple', 'left-arm', 'left-leg', 'left-kidney'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    leftSideFailures.push(test.replace('left-', ''));
                }
            });

            ['right-eye', 'right-ear', 'right-temple', 'right-arm', 'right-leg', 'right-kidney'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    rightSideFailures.push(test.replace('right-', ''));
                }
            });

            // Check head point failures from body reference section
            ['crown-gv20', 'yintang', 'gv17-occiput', 'sacrum-root'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    headPointFailures.push(test);
                }
            });

            // ADD bilateral failure alerts
            if (leftSideFailures.length >= 2) {
                alerts += `
                    <div class="pattern-alert">
                        🌙 <strong>LEFT-SIDE BILATERAL REVERSAL PATTERN</strong><br>
                        Failed: ${leftSideFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 LEFT Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger</button> + <button class='action-btn secondary' onclick='showEducationalKinesiologyInstructions()'>🎓 Left-Brain Integration</button>
                    </div>
                `;
            }

            if (rightSideFailures.length >= 2) {
                alerts += `
                    <div class="pattern-alert">
                        ☀️ <strong>RIGHT-SIDE BILATERAL REVERSAL PATTERN</strong><br>
                        Failed: ${rightSideFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger</button> + <button class='action-btn secondary' onclick='showEducationalKinesiologyInstructions()'>🎓 Right-Brain Integration</button>
                    </div>
                `;
            }

            // ADD head point failures from body reference testing
            if (headPointFailures.length > 0) {
                alerts += `
                    <div class="pattern-alert">
                        🧠 <strong>CRITICAL HEAD POINTS REVERSED IN BODY REFERENCE</strong><br>
                        Failed: ${headPointFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showQCIInstructions()'>🧪 QCI Application</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Brain Integration</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kali-phos", "Body Reference Head Point Support")'>🧂 Kali Phos Support</button>
                    </div>
                `;
            }

            // ADD kidney-adrenal pattern from body reference
            const kidneyFailures = [];
            if (interactiveTestStates.bodyParts.get('left-kidney') === 'reversed') kidneyFailures.push('left kidney');
            if (interactiveTestStates.bodyParts.get('right-kidney') === 'reversed') kidneyFailures.push('right kidney');

            if (kidneyFailures.length > 0) {
                alerts += `
                    <div class="pattern-alert warning">
                        🫘 <strong>KIDNEY-ADRENAL SYSTEM IMBALANCE</strong><br>
                        Failed: ${kidneyFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger (kidney support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kidney-support", "Kidney-Adrenal System Support")'>🧂 Constitutional Cell Salts</button> + <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Kidney Meridian Breathing</button>
                    </div>
                `;
            }
            
            // ✅ ADD: Respiratory system pattern analysis
            const respiratoryFailures = [];
            ['left-lung', 'right-lung', 'left-nostril', 'right-nostril'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    respiratoryFailures.push(test);
                }
            });

            if (respiratoryFailures.length > 0) {
                alerts += `
                    <div class="pattern-alert warning">
                        🫁 <strong>RESPIRATORY SYSTEM IMBALANCE</strong><br>
                        Failed: ${respiratoryFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ RING Finger (respiratory support)</button> + <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Breathing Exercises</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("respiratory-support", "Respiratory System Support")'>🧂 Immune Support Salts</button>
                    </div>
                `;
            }

            // ✅ ADD: Heart and throat specific recommendations
            const heartThroatFailures = [];
            if (interactiveTestStates.bodyParts.get('heart-cv14') === 'reversed') heartThroatFailures.push('heart');
            if (interactiveTestStates.bodyParts.get('throat-cv22') === 'reversed') heartThroatFailures.push('throat');

            if (heartThroatFailures.includes('heart')) {
                alerts += `
                    <div class="pattern-alert warning">
                        ❤️ <strong>HEART CENTER IMBALANCE</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger (heart/emotional support)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("magnesium-phos", "Heart Center Support")'>🧂 Magnesium Phosphate</button>
                        <br><small>Peak time: 12-2 PM | Focus: Cardiovascular + emotional stress</small>
                    </div>
                `;
            }

            if (heartThroatFailures.includes('throat')) {
                alerts += `
                    <div class="pattern-alert warning">
                        🗣️ <strong>THROAT/THYROID IMBALANCE</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger (communication/expression)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("thyroid-support", "Throat/Thyroid Support")'>🧂 Thyroid Support</button>
                        <br><small>Focus: Metabolic regulation + communication issues</small>
                    </div>
                `;
            }
            
            // Enhanced finger pattern analysis
            const fingerFailures = [];
            interactiveTestStates.fingers.forEach((state, key) => {
                if (state === 'reversed') {
                    const [hand, finger] = key.split('-');
                    fingerFailures.push(`${hand} ${finger}`);
                }
            });
            
            if (fingerFailures.length > 0) {
                alerts += `
                    <div class="pattern-alert warning">
                        🖐️ <strong>FINGER POLARITY REVERSALS DETECTED</strong><br>
                        Failed: ${fingerFailures.join(', ')}<br>
                        Protocol: <button class='action-btn secondary' onclick='showEducationalKinesiologyInstructions()'>🎓 Educational Kinesiology</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Specific Finger Holds</button> + <button class='action-btn secondary' onclick='showHydrationInstructions()'>💧 Hydration Protocol</button>
                    </div>
                `;
            }
            

            
            // Kidney-adrenal exhaustion pattern
            if (failurePatterns.main.has(2) && failurePatterns.main.has(21)) {
                alerts += `
                    <div class="pattern-alert">
                        ⚡ <strong>KIDNEY-ADRENAL EXHAUSTION DETECTED</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Finger Holds (20-60 min)</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions("kidney-support", "Kidney-Adrenal Exhaustion Support")'>🧂 Constitutional Cell Salts</button>
                    </div>
                `;
            }
            
            // Channel imbalance pattern
            if (failurePatterns.channel.has('ch1') || failurePatterns.channel.has('ch2')) {
                alerts += `
                    <div class="pattern-alert warning">
                        🌊 <strong>ENERGY CHANNEL IMBALANCE</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Alternate Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 Channel-Specific JSJ Holds</button>
                    </div>
                `;
            }
            
            // Biofield collapse pattern
            if (failurePatterns.biofield.has('bf1') && failurePatterns.biofield.has('bf2')) {
                alerts += `
                    <div class="pattern-alert warning">
                        ⭕ <strong>BIOFIELD COLLAPSE DETECTED</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showSection("troubleshooting")'>📡 Environmental EMF Assessment</button> + <button class='action-btn secondary' onclick='showSection("troubleshooting")'>🔷 BioGeometry Field Restoration</button>
                    </div>
                `;
            }
            
            // Battery reversal + multiple failures = systemic issue
            const totalFailures = failurePatterns.main.size + failurePatterns.channel.size + failurePatterns.biofield.size;
            if (totalFailures >= 5) {
                alerts += `
                    <div class="pattern-alert">
                        🔄 <strong>SYSTEMIC POLARITY DISRUPTION</strong><br>
                        Protocol: <button class='action-btn secondary' onclick='showCrossCrawlInstructions()'>🔄 Cross Crawl</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 Full JSJ Sequence</button> + <button class='action-btn secondary' onclick='showSection("troubleshooting")'>🧹 Environmental Clearing</button>
                    </div>
                `;
            }
            
            // Add specific point recommendations
            const specificProtocols = {
                // Main calibration specific failures
                1: "Hydration Protocol: <button class='action-btn secondary' onclick='showHydrationInstructions()'>💧 Pure Water + Electrolytes</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ THUMB Hold</button>",
                3: "Battery Reversal: <button class='action-btn secondary' onclick='showCrossCrawlInstructions()'>🔄 Cross Crawl</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>📏 String Length Adjustment</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Hold</button>", 
                4: "Finger Polarity: <button class='action-btn secondary' onclick='showEducationalKinesiologyInstructions()'>🎓 Educational Kinesiology</button> + <button class='action-btn secondary' onclick='showHydrationInstructions()'>💧 Hydration</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>⚖️ Polarity Correction</button>",
                5: "GV-20 Critical: <button class='action-btn secondary' onclick='showQCIInstructions()'>🧪 QCI Vial</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Brain Protocol</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions(\"kali-phos\", \"GV-20 Critical Support\")'>🧂 Kali Phos 4 pellets 3x daily</button>",
                6: "Yintang Critical: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>👁️ Third Eye Clearing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ INDEX Hold</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🔬 Constitutional Assessment</button>",
                8: "Eye Polarity: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>👀 Bilateral Testing</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>👁️ Visual System Support</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions(\"calc-fluor\", \"Eye Polarity Support\")'>🧂 Calc Fluor</button>",
                10: "Channel Imbalance: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Alternate Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Finger Sequence</button>",
                
                // Channel specific failures  
                'ch1': "Ida Weakness: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Left Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ MIDDLE Finger</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>❄️ Cooling Foods</button>",
                'ch2': "Pingala Weakness: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Right Nostril Breathing</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ LITTLE Finger</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🔥 Warming Foods</button>", 
                'ch3': "Channel Integration: <button class='action-btn secondary' onclick='showBreathingInstructions()'>🫁 Full Alternate Nostril</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ Sequential Holds</button>",
                
                // Biofield specific failures
                'bf1': "Central Column: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🦴 Spinal Alignment</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🌱 Grounding</button> + <button class='action-btn secondary' onclick='showJSJInstructions()'>🧘 JSJ THUMB for Foundation</button>",
                'bf2': "Upper Boundary: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>👑 Crown Chakra Work</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>⬆️ Upward Energy Flow</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions(\"kali-phos\", \"Upper Boundary Support\")'>🧂 Kali Phos</button>",
                'bf3': "Lower Boundary: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🌱 Root Grounding</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🌍 Earthing</button> + <button class='action-btn secondary' onclick='showCellSaltInstructions(\"calc-phos\", \"Lower Boundary Support\")'>🧂 Calc Phos</button>", 
                'bf4': "Side Boundaries: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>📡 Environmental EMF Check</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🔷 BioGeometry Shapes</button>",
                'bf5': "Field Distortion: <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🌍 Geopathic Stress Assessment</button> + <button class='action-btn secondary' onclick='showSection(\"troubleshooting\")'>🧹 Environmental Clearing</button>"
            };

            // Add individual point recommendations
            Object.keys(specificProtocols).forEach(pointId => {
                Object.values(failurePatterns).forEach(systemFailures => {
                    if (systemFailures.has(pointId)) {
                        alerts += `
                            <div class="pattern-alert warning">
                                🎯 <strong>Point ${pointId} Failed:</strong><br>
                                ${specificProtocols[pointId]}
                            </div>
                        `;
                    }
                });
            });
            
            analysisDiv.innerHTML = alerts || '<div class="pattern-alert info">✅ No critical failure patterns detected</div>';
        }

        function createAnalysisDiv() {
            const div = document.createElement('div');
            div.id = 'failurePatternAnalysis';
            div.style.marginTop = '20px';
            
            // Insert into troubleshooting section
            const troubleshooting = document.getElementById('troubleshooting');
            if (troubleshooting) {
                troubleshooting.insertBefore(div, troubleshooting.firstChild.nextSibling);
            }
            
            return div;
        }

        // Enhanced diagnostic system
        function updateComprehensiveDiagnostic() {
            const battery = document.querySelector('input[name="battery"]:checked')?.value;
            const fingers = document.querySelector('input[name="fingers"]:checked')?.value;
            const gv20 = document.querySelector('input[name="gv20"]:checked')?.value;
            const yintang = document.querySelector('input[name="yintang"]:checked')?.value;
            const channels = document.querySelector('input[name="channels"]:checked')?.value;
            const biofield = document.querySelector('input[name="biofield"]:checked')?.value;
            
            let results = '<h3>🤖 Comprehensive Multi-System Analysis</h3>';
            let overallStatus = 'good';
            let urgencyLevel = 'low';
            
            // Battery analysis
            if (battery === 'correct') {
                results += '<div class="diagnostic-result success">✅ Battery Calibration: Normal - Proceed with testing</div>';
            } else if (battery === 'reversed') {
                results += '<div class="diagnostic-result error">❌ Battery Calibration: REVERSED - Educational Kinesiology protocol needed</div>';
                overallStatus = 'error';
                urgencyLevel = 'high';
            } else if (battery === 'weak') {
                results += '<div class="diagnostic-result warning">⚠️ Battery Calibration: WEAK - Check hydration, JSJ finger holds indicated</div>';
                if (overallStatus === 'good') overallStatus = 'warning';
                urgencyLevel = 'medium';
            }
            
            // Critical head points analysis
            if (gv20 === 'positive' && yintang === 'positive') {
                results += '<div class="diagnostic-result success">✅ Head Points: OPTIMAL - Both GV-20 & Yintang positive</div>';
            } else if (gv20 === 'negative' || yintang === 'negative') {
                results += '<div class="diagnostic-result error">❌ Head Points: CRITICAL FAILURE - Immediate QCI + JSJ Brain Protocol required</div>';
                overallStatus = 'error';
                urgencyLevel = 'high';
            } else if (gv20 === 'weak' || yintang === 'weak') {
                results += '<div class="diagnostic-result error">❌ Head Points: WEAK - Constitutional cell salt assessment + JSJ support needed</div>';
                overallStatus = 'error';
                urgencyLevel = 'high';
            }
            
            // Channel analysis
            if (channels === 'balanced') {
                results += '<div class="diagnostic-result success">✅ Energy Channels: BALANCED - Ida/Pingala flowing normally</div>';
            } else if (channels === 'both_disrupted') {
                results += '<div class="diagnostic-result error">❌ Energy Channels: SEVERELY DISRUPTED - Environmental clearing + JSJ protocol urgent</div>';
                overallStatus = 'error';
                urgencyLevel = 'high';
            } else {
                results += '<div class="diagnostic-result warning">⚠️ Energy Channels: IMBALANCED - Alternate nostril breathing + targeted JSJ holds</div>';
                if (overallStatus === 'good') overallStatus = 'warning';
                if (urgencyLevel === 'low') urgencyLevel = 'medium';
            }
            
            // Biofield analysis
            if (biofield === 'strong') {
                results += '<div class="diagnostic-result success">✅ Toroidal Biofield: STRONG - Optimal energy circulation</div>';
            } else if (biofield === 'collapsed') {
                results += '<div class="diagnostic-result error">❌ Toroidal Biofield: COLLAPSED - Severe energy depletion, comprehensive protocol needed</div>';
                overallStatus = 'error';
                urgencyLevel = 'high';
            } else if (biofield === 'distorted') {
                results += '<div class="diagnostic-result warning">⚠️ Toroidal Biofield: EMF DISTORTION - Environmental assessment critical</div>';
                if (overallStatus === 'good') overallStatus = 'warning';
                if (urgencyLevel === 'low') urgencyLevel = 'medium';
            }
            
            // Multi-system integration recommendations
            results += '<h4 style="margin-top: 20px;">🔗 Integrated Protocol Recommendations:</h4>';
            
            if (overallStatus === 'error') {
                results += `
                    <div class="diagnostic-result error urgency-high">
                        🚨 <strong>STOP ALL TESTING - CRITICAL INTERVENTION REQUIRED</strong>
                        <h5>Immediate Actions (Priority Order):</h5>
                        <ol>
                            <li><strong>QCI Application:</strong> Place on GV-20 AND Yintang simultaneously</li>
                            <li><strong>JSJ Brain Protocol:</strong> All finger holds sequentially (10 min each)</li>
                            <li><strong>Constitutional Cell Salts:</strong> Complete assessment below</li>
                            <li><strong>Environmental Clearing:</strong> Check EMF/geopathic stress</li>
                            <li><strong>BioGeometry Enhancement:</strong> BG3 shapes for field restoration</li>
                        </ol>
                        <p><strong>Do NOT proceed with any other testing until all critical points test positive.</strong></p>
                    </div>
                `;
            } else if (overallStatus === 'warning') {
                results += `
                    <div class="diagnostic-result warning urgency-medium">
                        ⚠️ <strong>PROCEED WITH ENHANCED CAUTION</strong>
                        <h5>Recommended Support Protocol:</h5>
                        <ul>
                            <li><strong>JSJ Maintenance:</strong> Daily finger holds for weak systems</li>
                            <li><strong>Cell Salt Support:</strong> Constitutional assessment for mineral deficiencies</li>
                            <li><strong>Channel Balancing:</strong> Alternate nostril breathing 2x daily</li>
                            <li><strong>Biofield Monitoring:</strong> Weekly field integrity checks</li>
                        </ul>
                    </div>
                `;
            } else {
                results += `
                    <div class="diagnostic-result success urgency-low">
                        ✅ <strong>OPTIMAL PRACTITIONER CALIBRATION</strong>
                        <h5>Maintenance Protocol:</h5>
                        <ul>
                            <li><strong>Daily Calibration:</strong> Continue current protocol</li>
                            <li><strong>Constitutional Optimization:</strong> Consider seasonal cell salt adjustments</li>
                            <li><strong>System Enhancement:</strong> Advanced BioGeometry applications</li>
                            <li><strong>Professional Confidence:</strong> Proceed with all testing modalities</li>
                        </ul>
                    </div>
                `;
            }
            
            document.getElementById('comprehensiveDiagnosticResults').innerHTML = results;
            updateDynamicRecommendations();
        }

        // Enhanced dynamic recommendations system with specific guidance
        function updateDynamicRecommendations() {
            const recommendationsDiv = document.getElementById('dynamicRecommendations');
            
            let recommendations = '<div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; text-align: center;">';
            recommendations += '<h4>🎯 Smart Recommendations</h4>';
            
            // Check completion status and provide contextual recommendations
            const mainProgress = calculateProgress('main');
            const channelProgress = calculateProgress('channel');
            const biofieldProgress = calculateProgress('biofield');
            const totalTested = mainProgress.tested + channelProgress.tested + biofieldProgress.tested;
            const totalFailures = mainProgress.negative + channelProgress.negative + biofieldProgress.negative;
            
            if (totalTested === 0) {
                recommendations += '<p>Start with the main calibration sequence</p>';
            } else if (mainProgress.tested < 13) {
                recommendations += '<p>Complete main calibration first</p>';
            } else if (channelProgress.tested < 3) {
                recommendations += '<p>Test energy channels next</p>';
            } else if (biofieldProgress.tested < 5) {
                recommendations += '<p>Assess biofield integrity</p>';
            } else {
                recommendations += '<p>Run comprehensive diagnostic</p>';
            }
            
            // Add specific finger recommendations
            const fingerProgress = calculateFingerProgress();
            if (fingerProgress.total > 0) {
                if (fingerProgress.reversed > 0) {
                    recommendations += `<p style="margin-top: 10px; color: #ff6b7a;">🖐️ ${fingerProgress.reversed} finger(s) reversed - Use JSJ specific finger holds</p>`;
                    
                    // Specific finger recommendations
                    interactiveTestStates.fingers.forEach((state, key) => {
                        if (state === 'reversed') {
                            const [hand, finger] = key.split('-');
                            let jsjFinger = '';
                            if (finger === 'index') jsjFinger = 'INDEX (kidney support)';
                            else if (finger === 'middle') jsjFinger = 'MIDDLE (liver support)';
                            else if (finger === 'ring') jsjFinger = 'RING (lung support)';
                            else if (finger === 'little') jsjFinger = 'LITTLE (heart support)';
                            
                            recommendations += `<p style="font-size: 0.9rem; margin-top: 5px;">${hand} ${finger}: Hold ${jsjFinger} for 20-60 min</p>`;
                        }
                    });
                } else if (fingerProgress.correct === fingerProgress.total) {
                    recommendations += `<p style="margin-top: 10px; color: #2ed573;">✅ All fingers testing correctly!</p>`;
                }
            }
            
            // ✅ COMPREHENSIVE: Check ALL interactive body points
            const criticalHeadFailures = [];
            const kidneyFailures = [];
            const respiratoryFailures = [];
            const heartThroatFailures = [];

            // Check critical head points
            ['crown-gv20', 'yintang', 'gv17-occiput', 'sacrum-root'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    criticalHeadFailures.push(test);
                }
            });

            // Check kidneys
            if (interactiveTestStates.bodyParts.get('left-kidney') === 'reversed') kidneyFailures.push('left kidney');
            if (interactiveTestStates.bodyParts.get('right-kidney') === 'reversed') kidneyFailures.push('right kidney');

            // Check respiratory
            ['left-lung', 'right-lung', 'left-nostril', 'right-nostril'].forEach(test => {
                const state = interactiveTestStates.bodyParts.get(test);
                if (state === 'reversed') {
                    respiratoryFailures.push(test);
                }
            });

            // ✅ ADD: Check heart and throat
            if (interactiveTestStates.bodyParts.get('heart-cv14') === 'reversed') heartThroatFailures.push('heart');
            if (interactiveTestStates.bodyParts.get('throat-cv22') === 'reversed') heartThroatFailures.push('throat');

            // ✅ ENHANCED RECOMMENDATIONS (immediate feedback)
            if (criticalHeadFailures.length > 0) {
                recommendations += `<p style="margin-top: 10px; color: #ff4757;"><strong>🚨 HEAD POINTS: ${criticalHeadFailures.length} critical - QCI + JSJ Brain Protocol</strong></p>`;
            }

            if (kidneyFailures.length > 0) {
                recommendations += `<p style="margin-top: 10px; color: #ffa726;">🫘 KIDNEYS: ${kidneyFailures.join(', ')} - JSJ INDEX finger + constitutional support</p>`;
            }

            if (respiratoryFailures.length > 0) {
                recommendations += `<p style="margin-top: 10px; color: #ffa726;">🫁 RESPIRATORY: ${respiratoryFailures.length} point(s) - JSJ RING finger + breathing exercises</p>`;
            }

            if (heartThroatFailures.includes('heart')) {
                recommendations += `<p style="margin-top: 10px; color: #ff6b7a;">❤️ HEART: JSJ LITTLE finger (peak 12-2 PM) + cardiovascular support</p>`;
            }

            if (heartThroatFailures.includes('throat')) {
                recommendations += `<p style="margin-top: 10px; color: #17a2b8;">🗣️ THROAT: JSJ LITTLE finger + metabolic/thyroid support</p>`;
            }
            
            // Add failure-based recommendations
            if (totalFailures > 0) {
                recommendations += `<p style="margin-top: 10px; color: #ff6b7a;">⚠️ ${totalFailures} test failures detected - Check troubleshooting section</p>`;
            }
            
            // Add time-based recommendations
            const hour = new Date().getHours();
            if (hour >= 6 && hour <= 10) {
                recommendations += '<p style="margin-top: 10px; font-size: 0.9rem;">🌅 Morning optimal time for calibration</p>';
            } else if (hour >= 18 && hour <= 20) {
                recommendations += '<p style="margin-top: 10px; font-size: 0.9rem;">🌆 Evening - good for JSJ kidney support</p>';
            }
            
            recommendations += '</div>';
            recommendationsDiv.innerHTML = recommendations;
        }

        // Cell salt constitutional system
        function calculateConstitution() {
            const birthDate = document.getElementById('birthDate').value;
            if (!birthDate) return;
            
            const birth = new Date(birthDate);
            const conception = new Date(birth);
            conception.setMonth(birth.getMonth() - 9);
            
            const zodiacalSalts = [
                {sign: 'Aries', dates: 'Mar 21 - Apr 19', salt: 'Kali Phosphoricum', function: 'Brain/nervous system'},
                {sign: 'Taurus', dates: 'Apr 20 - May 20', salt: 'Natrum Sulphuricum', function: 'Liver/water elimination'},
                {sign: 'Gemini', dates: 'May 21 - Jun 20', salt: 'Kali Muriaticum', function: 'Blood/glandular'},
                {sign: 'Cancer', dates: 'Jun 21 - Jul 22', salt: 'Calcarea Fluorica', function: 'Tissue elasticity'},
                {sign: 'Leo', dates: 'Jul 23 - Aug 22', salt: 'Magnesium Phosphate', function: 'Muscle/nerve'},
                {sign: 'Virgo', dates: 'Aug 23 - Sep 22', salt: 'Kali Sulphuricum', function: 'Skin/oil formation'},
                {sign: 'Libra', dates: 'Sep 23 - Oct 22', salt: 'Natrium Phosphoricum', function: 'Acid balance'},
                {sign: 'Scorpio', dates: 'Oct 23 - Nov 21', salt: 'Calcarea Sulphurica', function: 'Blood purification'},
                {sign: 'Sagittarius', dates: 'Nov 22 - Dec 21', salt: 'Silicea', function: 'Structural support'},
                {sign: 'Capricorn', dates: 'Dec 22 - Jan 20', salt: 'Calcarea Phosphorica', function: 'Bone formation'},
                {sign: 'Aquarius', dates: 'Jan 21 - Feb 19', salt: 'Natrium Muriaticum', function: 'Water distribution'},
                {sign: 'Pisces', dates: 'Feb 20 - Mar 20', salt: 'Ferrum Phosphoricum', function: 'Oxygen transport'}
            ];
            
            // Determine birth sign
            const birthSign = getZodiacSign(birth);
            const birthSalt = zodiacalSalts.find(s => s.sign === birthSign);
            
            let results = `<div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; margin-top: 15px;">`;
            results += `<h5>Constitutional Analysis for ${birthDate}</h5>`;
            results += `<p><strong>Birth Salt:</strong> ${birthSalt.salt} (${birthSalt.function})</p>`;
            results += `<p><strong>Conception Date:</strong> ~${conception.toLocaleDateString()}</p>`;
            results += `<p><strong>Gestation Period:</strong> 9 months of zodiacal salt exposure</p>`;
            results += `</div>`;
            
            document.getElementById('constitutionalResults').innerHTML = results;
        }

        function getZodiacSign(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            
            if ((month == 3 && day >= 21) || (month == 4 && day <= 19)) return 'Aries';
            if ((month == 4 && day >= 20) || (month == 5 && day <= 20)) return 'Taurus';
            if ((month == 5 && day >= 21) || (month == 6 && day <= 20)) return 'Gemini';
            if ((month == 6 && day >= 21) || (month == 7 && day <= 22)) return 'Cancer';
            if ((month == 7 && day >= 23) || (month == 8 && day <= 22)) return 'Leo';
            if ((month == 8 && day >= 23) || (month == 9 && day <= 22)) return 'Virgo';
            if ((month == 9 && day >= 23) || (month == 10 && day <= 22)) return 'Libra';
            if ((month == 10 && day >= 23) || (month == 11 && day <= 21)) return 'Scorpio';
            if ((month == 11 && day >= 22) || (month == 12 && day <= 21)) return 'Sagittarius';
            if ((month == 12 && day >= 22) || (month == 1 && day <= 20)) return 'Capricorn';
            if ((month == 1 && day >= 21) || (month == 2 && day <= 19)) return 'Aquarius';
            if ((month == 2 && day >= 20) || (month == 3 && day <= 20)) return 'Pisces';
        }

        function generateCellSaltRecommendations() {
            const recommendations = document.getElementById('cellSaltRecommendations');
            let content = '<div class="recommendation-panel">';
            content += '<h4>🧬 Personalized Cell Salt Protocol</h4>';
            
            // Check facial indicators
            const indicators = [];
            if (document.getElementById('greyOcular').checked) indicators.push('Kali Phos (brain support)');
            if (document.getElementById('yellowComplexion').checked) indicators.push('Nat Sulph (liver detox)');
            if (document.getElementById('whiteCoating').checked) indicators.push('Kali Mur (blood purification)');
            if (document.getElementById('brownCoating').checked) indicators.push('Multiple deficiencies - 12-in-1 combination');
            if (document.getElementById('squareEyes').checked) indicators.push('Calc Fluor (tissue elasticity)');
            
            if (indicators.length > 0) {
                content += '<h5>Immediate Needs (Based on Facial Diagnosis):</h5><ul>';
                indicators.forEach(indicator => content += `<li>${indicator}</li>`);
                content += '</ul>';
            }
            
            // Check symptoms
            const symptoms = [];
            if (document.getElementById('mentalFatigue').checked) symptoms.push('Kali Phos - 4 pellets 3x daily');
            if (document.getElementById('digestiveIssues').checked) symptoms.push('Nat Phos - 4 pellets before meals');
            if (document.getElementById('jointStiffness').checked) symptoms.push('Calc Fluor - 4 pellets 2x daily');
            if (document.getElementById('poorSleep').checked) symptoms.push('Kali Phos - 4 pellets before bed');
            if (document.getElementById('skinProblems').checked) symptoms.push('Kali Sulph - 4 pellets 2x daily');
            
            if (symptoms.length > 0) {
                content += '<h5>Symptom-Based Protocol:</h5><ul>';
                symptoms.forEach(symptom => content += `<li>${symptom}</li>`);
                content += '</ul>';
            }
            
            content += '<h5>Timing Optimization:</h5>';
            content += '<p>Take salts 30 minutes before meals or 2 hours after. Let dissolve under tongue.</p>';
            content += '<p>Follow lunar cycles: New moon for detox salts, Full moon for building salts.</p>';
            content += '</div>';
            
            recommendations.innerHTML = content;
        }

        // Enhanced export functions with detailed sub-component data
        function exportComprehensiveReport() {
            const mainProgress = calculateProgress('main');
            const channelProgress = calculateProgress('channel');
            const biofieldProgress = calculateProgress('biofield');
            const detailedProgress = getDetailedProgress();
            
            const reportData = {
                timestamp: new Date().toISOString(),
                mainCalibration: {
                    positive: mainProgress.positive,
                    negative: mainProgress.negative,
                    weak: mainProgress.weak,
                    total: mainProgress.total,
                    testStates: Object.fromEntries(testStates.main)
                },
                energyChannels: {
                    positive: channelProgress.positive,
                    negative: channelProgress.negative,
                    weak: channelProgress.weak,
                    total: channelProgress.total,
                    testStates: Object.fromEntries(testStates.channel)
                },
                biofieldAssessment: {
                    positive: biofieldProgress.positive,
                    negative: biofieldProgress.negative,
                    weak: biofieldProgress.weak,
                    total: biofieldProgress.total,
                    testStates: Object.fromEntries(testStates.biofield)
                },
                detailedTesting: {
                    fingers: Object.fromEntries(interactiveTestStates.fingers),
                    bodyParts: Object.fromEntries(interactiveTestStates.bodyParts),
                    objects: Object.fromEntries(interactiveTestStates.objects)
                },
                subComponentProgress: {
                    fingers: detailedProgress.subComponents.fingers,
                    eyes: detailedProgress.subComponents.eyes,
                    hands: detailedProgress.subComponents.hands
                },
                failurePatterns: {
                    main: Array.from(failurePatterns.main),
                    channel: Array.from(failurePatterns.channel),
                    biofield: Array.from(failurePatterns.biofield)
                },
                diagnosticResults: diagnosticData,
                recommendations: getDynamicRecommendationText(),
                sessionType: 'Enhanced Multi-State Assessment with Detailed Testing'
            };
            
            const blob = new Blob([JSON.stringify(reportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `enhanced-polarity-assessment-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function getDynamicRecommendationText() {
            // Extract current recommendation text for export
            const recDiv = document.getElementById('dynamicRecommendations');
            return recDiv ? recDiv.textContent : 'No recommendations available';
        }

        function saveEnhancedSession() {
            const sessionData = {
                testStates: testStates,
                interactiveTestStates: interactiveTestStates,
                failurePatterns: {
                    main: Array.from(failurePatterns.main),
                    channel: Array.from(failurePatterns.channel),
                    biofield: Array.from(failurePatterns.biofield)
                },
                timestamp: new Date().toISOString(),
                diagnosticInputs: collectDiagnosticInputs()
            };
            
            localStorage.setItem('enhancedPolaritySession', JSON.stringify(sessionData));
            alert('Enhanced session saved successfully');
        }

        function collectDiagnosticInputs() {
            return {
                battery: document.querySelector('input[name="battery"]:checked')?.value,
                fingers: document.querySelector('input[name="fingers"]:checked')?.value,
                gv20: document.querySelector('input[name="gv20"]:checked')?.value,
                yintang: document.querySelector('input[name="yintang"]:checked')?.value,
                channels: document.querySelector('input[name="channels"]:checked')?.value,
                biofield: document.querySelector('input[name="biofield"]:checked')?.value
            };
        }

        function printChecklist() {
            window.print();
        }

        // Search functionality
        function filterContent() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.polarity-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm) || searchTerm === '') {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Manual session loading
        function loadLastSession() {
            const savedSession = localStorage.getItem('enhancedPolaritySession');
            if (savedSession) {
                if (confirm('Load last saved session? Current progress will be lost.')) {
                    location.reload(); // Simple way to reload with saved session
                }
            } else {
                alert('No saved session found');
            }
        }

        // Save session to downloadable file
        function saveSessionToFile() {
            const sessionData = {
                testStates: testStates,
                failurePatterns: {
                    main: Array.from(failurePatterns.main),
                    channel: Array.from(failurePatterns.channel),
                    biofield: Array.from(failurePatterns.biofield)
                },
                timestamp: new Date().toISOString(),
                diagnosticInputs: collectDiagnosticInputs(),
                sessionType: 'Enhanced Polarity Session'
            };
            
            const blob = new Blob([JSON.stringify(sessionData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `polarity-session-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            alert('Session saved to Downloads folder');
        }

        // Load session from uploaded file
        function loadSessionFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const sessionData = JSON.parse(e.target.result);
                            
                            if (confirm('Load session from file? Current progress will be lost.')) {
                                // Clear current state
                                clearAllStates(false); // Don't show alert
                                
                                // Load session data
                                if (sessionData.testStates) {
                                    testStates = sessionData.testStates;
                                    // Update UI to reflect loaded states
                                    Object.entries(testStates).forEach(([system, states]) => {
                                        states.forEach((state, id) => {
                                            const element = document.querySelector(`[onclick*="cycleTestState"][onclick*="${id}"][onclick*="${system}"]`);
                                            if (element) {
                                                const btn = element.querySelector('.multi-state-btn');
                                                if (btn) {
                                                    btn.className = `multi-state-btn ${state}`;
                                                    btn.dataset.state = state;
                                                    const symbols = ['⭕', '✅', '❌', '⚠️'];
                                                    const states = ['not-tested', 'positive', 'negative', 'weak'];
                                                    const index = states.indexOf(state);
                                                    btn.textContent = symbols[index] || '⭕';
                                                }
                                            }
                                        });
                                    });
                                }
                                
                                // Restore diagnostic inputs
                                if (sessionData.diagnosticInputs) {
                                    Object.entries(sessionData.diagnosticInputs).forEach(([name, value]) => {
                                        if (value) {
                                            const input = document.querySelector(`input[name="${name}"][value="${value}"]`);
                                            if (input) input.checked = true;
                                        }
                                    });
                                }
                                
                                updateAllProgress();
                                updateDynamicRecommendations();
                                analyzeFailurePatterns();
                                
                                alert('Session loaded successfully from file');
                            }
                        } catch (error) {
                            alert('Error loading session file: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            
            input.click();
        }

        // Clear saved sessions from browser memory
        function clearSavedSessions() {
            if (confirm('Clear all saved sessions from browser memory?')) {
                localStorage.removeItem('enhancedPolaritySession');
                alert('Saved sessions cleared from browser memory');
            }
        }

        // Update clearAllStates to not clear saves by default
        function clearAllStates(showAlert = true) {
            if (showAlert && !confirm('Clear all test results? This cannot be undone.')) {
                return;
            }
            
            // Reset all test states
            testStates = {
                main: new Map(),
                channel: new Map(), 
                biofield: new Map()
            };
            
            // Reset failure patterns
            failurePatterns = {
                main: new Set(),
                channel: new Set(),
                biofield: new Set()
            };

            // Reset interactive testing states
            interactiveTestStates = {
                fingers: new Map(),
                bodyParts: new Map(),
                objects: new Map()
            };

            // ✅ PROPERLY reset interactive polarity indicators to TRUE untested state
            document.querySelectorAll('.interactive-polarity').forEach(indicator => {
                // Clear any existing state classes
                indicator.className = 'polarity-indicator interactive-polarity';
                
                // Reset to true untested grey appearance
                indicator.style.backgroundColor = '#6c757d';
                indicator.style.color = 'white';
                indicator.style.border = '2px solid #6c757d';
                indicator.style.opacity = '0.7';
                
                // Reset text content to original
                if (indicator.textContent.includes('Test Point')) {
                    indicator.textContent = 'Test Point';
                }
            });
            
            // Reset all buttons to not-tested
            document.querySelectorAll('.multi-state-btn').forEach(btn => {
                btn.className = 'multi-state-btn not-tested';
                btn.dataset.state = 'not-tested';
                btn.textContent = '⭕';
            });

            // Reset finger status indicators
            document.querySelectorAll('.finger-status').forEach(status => {
                status.textContent = '⭕';
                status.className = 'finger-status';
            });
            
            // Reset diagnostic inputs
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Reset bilateral analysis status
            const bilateralStatus = document.getElementById('bilateralAnalysisStatus');
            if (bilateralStatus) {
                bilateralStatus.textContent = 'Ready for analysis';
                bilateralStatus.className = 'analysis-status ready';
            }
            
            // Update displays
            updateAllProgress();
            updateDynamicRecommendations();
            analyzeFailurePatterns();
            
            // ✅ FORCE complete state reset
            setTimeout(() => {
                updateBilateralFeedbackImmediate();
                analyzeFailurePatterns();
                updateDynamicRecommendations();
            }, 100);
            
            if (showAlert) {
                alert('All test results cleared successfully!');
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            updateAllProgress();
            updateDynamicRecommendations();
            analyzeFailurePatterns();
            
            // Initialize analysis status
            updateAnalysisStatus();
            
            // Load saved session if available
            const savedSession = localStorage.getItem('enhancedPolaritySession');
            if (savedSession) {
                const sessionData = JSON.parse(savedSession);
                

                

                

                
                // Restore diagnostic inputs
                if (sessionData.diagnosticInputs) {
                    Object.entries(sessionData.diagnosticInputs).forEach(([name, value]) => {
                        if (value) {
                            const input = document.querySelector(`input[name="${name}"][value="${value}"]`);
                            if (input) input.checked = true;
                        }
                    });
                }

                // Restore test states if available
                if (sessionData.testStates) {
                    testStates = sessionData.testStates;
                    // Update UI to reflect saved states
                    Object.entries(testStates).forEach(([system, states]) => {
                        states.forEach((state, id) => {
                            const element = document.querySelector(`[onclick*="cycleTestState"][onclick*="${id}"][onclick*="${system}"]`);
                            if (element) {
                                const btn = element.querySelector('.multi-state-btn');
                                if (btn) {
                                    btn.className = `multi-state-btn ${state}`;
                                    btn.dataset.state = state;
                                    const symbols = ['⭕', '✅', '❌', '⚠️'];
                                    const states = ['not-tested', 'positive', 'negative', 'weak'];
                                    const index = states.indexOf(state);
                                    btn.textContent = symbols[index] || '⭕';
                                }
                            }
                        });
                    });
                }

                // Restore interactive testing states if available
                if (sessionData.interactiveTestStates) {
                    interactiveTestStates = sessionData.interactiveTestStates;
                    
                    // Restore finger states
                    Object.entries(interactiveTestStates.fingers).forEach(([key, state]) => {
                        const [hand, finger] = key.split('-');
                        const element = document.querySelector(`[data-hand="${hand}"][data-finger="${finger}"]`);
                        if (element) {
                            const statusDiv = element.querySelector('.finger-status');
                            if (statusDiv) {
                                statusDiv.textContent = state === 'untested' ? '⭕' : 
                                                      state === 'correct' ? '✅' : '❌';
                                statusDiv.className = `finger-status ${state}`;
                            }
                        }
                    });
                    
                    // Restore body part states
                    Object.entries(interactiveTestStates.bodyParts).forEach(([test, state]) => {
                        const element = document.querySelector(`[data-test="${test}"]`);
                        if (element) {
                            const expected = element.dataset.expected;
                            element.className = `polarity-indicator ${expected} interactive-polarity ${state}`;
                        }
                    });
                }

                // Restore failure patterns if available
                if (sessionData.failurePatterns) {
                    failurePatterns.main = new Set(sessionData.failurePatterns.main || []);
                    failurePatterns.channel = new Set(sessionData.failurePatterns.channel || []);
                    failurePatterns.biofield = new Set(sessionData.failurePatterns.biofield || []);
                }
                
                updateAllProgress();
                updateDynamicRecommendations();
                analyzeFailurePatterns();
                
                // Update analysis status after restoring session
                updateAnalysisStatus();
            }
            
            // Set up periodic auto-save
            setInterval(() => {
                const hasData = Object.values(testStates).some(states => states.size > 0);
                if (hasData) {
                    saveEnhancedSession();
                }
            }, 300000); // Auto-save every 5 minutes
        });
    </script>
</body>
</html>